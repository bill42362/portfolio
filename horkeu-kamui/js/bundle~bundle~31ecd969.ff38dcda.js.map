{"version":3,"sources":["webpack:///./src/client/img/x-men-school.svg","webpack:///./node_modules/three/examples/jsm/loaders/TGALoader.js","webpack:///./node_modules/three/examples/jsm/loaders/MMDLoader.js","webpack:///./node_modules/three/examples/jsm/loaders/DDSLoader.js","webpack:///./src/client/model/Horkeukamui/Horkeukamui-160.pmx","webpack:///./src/client/model/Horkeukamui/tex/body_N.png","webpack:///./src/client/model/Horkeukamui/tex/body.dds","webpack:///./src/client/model/Horkeukamui/tex/body2_N.png","webpack:///./src/client/model/Horkeukamui/tex/body2.dds","webpack:///./src/client/model/Horkeukamui/tex/cloth_N.png","webpack:///./src/client/model/Horkeukamui/tex/cloth.dds","webpack:///./src/client/model/Horkeukamui/tex/cloth2.dds","webpack:///./src/client/model/Horkeukamui/tex/cloth3.dds","webpack:///./src/client/model/Horkeukamui/tex/cloth4.dds","webpack:///./src/client/model/Horkeukamui/tex/cloth23_N.png","webpack:///./src/client/model/Horkeukamui/tex/head.dds","webpack:///./src/client/model/Horkeukamui/tex/nose.dds","webpack:///./src/client/model/Horkeukamui/tex/Penis.dds","webpack:///./src/client/model/Horkeukamui/tex/toon.dds","webpack:///./src/client/js/component/Main.jsx","webpack:///./src/client/img/github-icon.svg","webpack:///./src/client/js/component/Footer.jsx","webpack:///./src/client/img/email-icon.svg","webpack:///./src/client/js/index.js","webpack:///(webpack)/buildin/global.js","webpack:///./src/client/js/component/App.jsx"],"names":["manager","super","buffer","TGA_TYPE_NO_DATA","TGA_TYPE_INDEXED","TGA_TYPE_RGB","TGA_TYPE_GREY","TGA_TYPE_RLE_INDEXED","TGA_TYPE_RLE_RGB","TGA_TYPE_RLE_GREY","TGA_ORIGIN_MASK","TGA_ORIGIN_SHIFT","TGA_ORIGIN_BL","TGA_ORIGIN_BR","TGA_ORIGIN_UL","TGA_ORIGIN_UR","length","console","error","offset","content","Uint8Array","header","id_length","colormap_type","image_type","colormap_index","colormap_length","colormap_size","origin","width","height","pixel_size","flags","tgaCheckHeader","use_rle","use_pal","use_grey","imageData","result","data","pixel_data","palettes","pixel_total","subarray","c","count","i","shift","pixels","set","tgaParse","image","palette","x_start","y_start","x_step","y_step","x_end","y_end","color","x","y","tgaGetImageDataGrey8bits","tgaGetImageDataGrey16bits","colormap","tgaGetImageData8bits","tgaGetImageData16bits","tgaGetImageData24bits","tgaGetImageData32bits","getTgaRGBA","flipY","generateMipmaps","minFilter","this","loader","parser","meshBuilder","animationBuilder","animationPath","url","onLoad","onProgress","onError","builder","setCrossOrigin","crossOrigin","resourcePath","path","extractUrlBase","modelExtension","_extractExtension","toLowerCase","build","Error","object","loadVMD","vmd","isCamera","buildCameraAnimation","modelUrl","vmdUrl","scope","load","mesh","loadAnimation","animation","_getParser","setMimeType","undefined","setPath","setResponseType","setRequestHeader","requestHeader","setWithCredentials","withCredentials","parsePmd","parsePmx","urls","Array","isArray","vmds","vmdNum","il","push","parseVmd","mergeVmds","isUnicode","text","parseVpd","index","lastIndexOf","slice","Parser","DEFAULT_TOON_TEXTURES","geometryBuilder","materialBuilder","geometry","material","setResourcePath","skeleton","bones","gbone","bone","name","position","fromArray","pos","quaternion","rotq","scl","scale","parent","add","updateMatrixWorld","initBones","bind","positions","uvs","normals","indices","groups","skinIndices","skinWeights","morphTargets","morphPositions","iks","grants","rigidBodies","constraints","boneTypeTable","metadata","vertexCount","v","vertices","j","jl","normal","uv","faceCount","face","faces","materialCount","materials","rigidBodyCount","body","value","boneIndex","type","Math","max","boneCount","boneData","transformationClass","parentIndex","rigidBodyType","format","ikCount","ik","param","target","effector","iteration","maxAngle","links","link","enabled","indexOf","limitation","angleLimitation","rotationMin","lowerLimitationAngle","rotationMax","upperLimitationAngle","tmp1","tmp2","grantEntryMap","grant","ratio","isLocal","affectRotation","affectPosition","children","visited","rootEntry","grantEntry","parentGrantEntry","traverse","entry","child","updateAttributes","attribute","morph","elementCount","element","elements","morphs","array","morphCount","params","morph2","rigidBody","key","constraintCount","constraint","bodyA","rigidBodyIndex1","bodyB","rigidBodyIndex2","setAttribute","setIndex","addGroup","morphAttributes","morphTargetsRelative","userData","MMD","computeBoundingSphere","textureLoader","tgaLoader","textures","diffuse","opacity","emissive","ambient","transparent","skinning","fog","blending","blendSrc","blendDst","blendSrcAlpha","blendDstAlpha","flag","side","fileName","fileNames","split","map","_loadTexture","extension","envMap","combine","toonFileName","toonIndex","toonTextures","gradientMap","isToonTexture","isDefaultToonTexture","_isDefaultToonTexture","outlineParameters","thickness","edgeFlag","alpha","visible","isDefaultToon","textureIndex","envTextureIndex","envFlag","toonFlag","edgeSize","edgeColor","_checkImageTransparency","multiplyScalar","checkAlphaMorph","test","filePath","fullPath","parseInt","match","e","warn","getHandler","_getTGALoader","texture","t","_getRotatedImage","magFilter","wrapS","wrapT","readyCallbacks","canvas","document","createElement","context","getContext","clearRect","translate","rotate","PI","drawImage","getImageData","groupIndex","getAlphaByUv","round","createImageData","group","centerUV","detectImageTransparency","attributes","start","tracks","buildSkeletalAnimation","tracks2","buildMorphAnimation","pushInterpolation","interpolation","motions","boneNameDictionary","motionCount","motion","boneName","sort","a","b","frameNum","times","rotations","pInterpolations","rInterpolations","basePosition","getBoneByName","toArray","time","rotation","targetName","_createTrack","morphTargetDictionary","morphName","values","weight","pushVector3","vec","z","cameras","centers","quaternions","fovs","cInterpolations","qInterpolations","fInterpolations","euler","center","rot","distance","fov","setFromEuler","applyQuaternion","q","w","node","typedKeyframeTrack","interpolations","stride","interpolateStride","aheadIndex","endIndex","track","createInterpolant","getValueSize","Float32Array","parameterPositions","sampleValues","sampleSize","resultBuffer","interpolationParams","i1","t0","t1","valueSize","offset1","offset0","weight1","x1","x2","y1","y2","_calculate","slerpFlat","s","math","sst3","stt3","ttt","ft","abs","loadMipmaps","dds","mipmaps","mipmapCount","fourCCToInt32","charCodeAt","loadARGBMip","dataOffset","dataLength","srcBuffer","byteArray","dst","src","g","r","FOURCC_DXT1","FOURCC_DXT3","FOURCC_DXT5","FOURCC_ETC1","Int32Array","blockBytes","fourCC","isRGBAUncompressed","String","fromCharCode","caps2","isCubemap","mipmap","loadingManager","LoadingManager","addHandler","DDSLoader","mmdLoader","MMDLoader","Main","React","createRef","gui","camera","cameraControls","scene","renderer","rendererControlFolder","clock","animationFrame","animationControls","shouldAnimate","fps","animationToogleUI","stopAnimationTimeout","initRenderer","WebGLRenderer","current","antialias","physicallyCorrectLights","toneMappingExposure","shadowMap","setClearColor","addFolder","min","step","initCamera","handleWindowResize","renderNextFrame","render","tick","update","window","requestAnimationFrame","clientWidth","clientHeight","PerspectiveCamera","OrbitControls","enableDamping","addEventListener","setValue","clearTimeout","setTimeout","throttle","setSize","setPixelRatio","devicePixelRatio","aspect","updateProjectionMatrix","loadModels","log","MMDAnimationHelper","Horkeukamui160","mmd","Horkeukamui","forEach","dat","hideable","closed","closeOnTop","Scene","AxesHelper","onChange","destory","cancelAnimationFrame","removeEventListener","StyledMain","Canvas","ref","PureComponent","styled","div","githubBaseUrl","Footer","props","email","branchName","githubUrl","StyledFooter","Link","href","GithubIcon","alt","propTypes","PropTypes","string","defaultProps","ReactDOM","getElementById","Function","module","exports","GlobalStyle","createGlobalStyle","styledNormalize","isServer","title","description","process","env","BRANCH_NAME","__SSR_ENVIRONMENT__","App","request","defaultTitle","titleTemplate","charSet","property","StyledApp","XMenLogoSource","Body","sheet","instance"],"mappings":"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","file":"js/bundle~bundle~31ecd969.ff38dcda.js","sourcesContent":["export default __webpack_public_path__ + \"img/x-men-school.0928a818.svg\";","import {\n\tDataTextureLoader,\n\tLinearMipmapLinearFilter\n} from 'three';\n\nclass TGALoader extends DataTextureLoader {\n\n\tconstructor( manager ) {\n\n\t\tsuper( manager );\n\n\t}\n\n\tparse( buffer ) {\n\n\t\t// reference from vthibault, https://github.com/vthibault/roBrowser/blob/master/src/Loaders/Targa.js\n\n\t\tfunction tgaCheckHeader( header ) {\n\n\t\t\tswitch ( header.image_type ) {\n\n\t\t\t\t// check indexed type\n\n\t\t\t\tcase TGA_TYPE_INDEXED:\n\t\t\t\tcase TGA_TYPE_RLE_INDEXED:\n\t\t\t\t\tif ( header.colormap_length > 256 || header.colormap_size !== 24 || header.colormap_type !== 1 ) {\n\n\t\t\t\t\t\tconsole.error( 'THREE.TGALoader: Invalid type colormap data for indexed type.' );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak;\n\n\t\t\t\t\t// check colormap type\n\n\t\t\t\tcase TGA_TYPE_RGB:\n\t\t\t\tcase TGA_TYPE_GREY:\n\t\t\t\tcase TGA_TYPE_RLE_RGB:\n\t\t\t\tcase TGA_TYPE_RLE_GREY:\n\t\t\t\t\tif ( header.colormap_type ) {\n\n\t\t\t\t\t\tconsole.error( 'THREE.TGALoader: Invalid type colormap data for colormap type.' );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tbreak;\n\n\t\t\t\t\t// What the need of a file without data ?\n\n\t\t\t\tcase TGA_TYPE_NO_DATA:\n\t\t\t\t\tconsole.error( 'THREE.TGALoader: No data.' );\n\n\t\t\t\t\t// Invalid type ?\n\n\t\t\t\tdefault:\n\t\t\t\t\tconsole.error( 'THREE.TGALoader: Invalid type \"%s\".', header.image_type );\n\n\t\t\t}\n\n\t\t\t// check image width and height\n\n\t\t\tif ( header.width <= 0 || header.height <= 0 ) {\n\n\t\t\t\tconsole.error( 'THREE.TGALoader: Invalid image size.' );\n\n\t\t\t}\n\n\t\t\t// check image pixel size\n\n\t\t\tif ( header.pixel_size !== 8 && header.pixel_size !== 16 &&\n\t\t\t\theader.pixel_size !== 24 && header.pixel_size !== 32 ) {\n\n\t\t\t\tconsole.error( 'THREE.TGALoader: Invalid pixel size \"%s\".', header.pixel_size );\n\n\t\t\t}\n\n\t\t}\n\n\t\t// parse tga image buffer\n\n\t\tfunction tgaParse( use_rle, use_pal, header, offset, data ) {\n\n\t\t\tlet pixel_data,\n\t\t\t\tpalettes;\n\n\t\t\tconst pixel_size = header.pixel_size >> 3;\n\t\t\tconst pixel_total = header.width * header.height * pixel_size;\n\n\t\t\t // read palettes\n\n\t\t\t if ( use_pal ) {\n\n\t\t\t\t palettes = data.subarray( offset, offset += header.colormap_length * ( header.colormap_size >> 3 ) );\n\n\t\t\t }\n\n\t\t\t // read RLE\n\n\t\t\t if ( use_rle ) {\n\n\t\t\t\t pixel_data = new Uint8Array( pixel_total );\n\n\t\t\t\tlet c, count, i;\n\t\t\t\tlet shift = 0;\n\t\t\t\tconst pixels = new Uint8Array( pixel_size );\n\n\t\t\t\twhile ( shift < pixel_total ) {\n\n\t\t\t\t\tc = data[ offset ++ ];\n\t\t\t\t\tcount = ( c & 0x7f ) + 1;\n\n\t\t\t\t\t// RLE pixels\n\n\t\t\t\t\tif ( c & 0x80 ) {\n\n\t\t\t\t\t\t// bind pixel tmp array\n\n\t\t\t\t\t\tfor ( i = 0; i < pixel_size; ++ i ) {\n\n\t\t\t\t\t\t\tpixels[ i ] = data[ offset ++ ];\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// copy pixel array\n\n\t\t\t\t\t\tfor ( i = 0; i < count; ++ i ) {\n\n\t\t\t\t\t\t\tpixel_data.set( pixels, shift + i * pixel_size );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tshift += pixel_size * count;\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\t// raw pixels\n\n\t\t\t\t\t\tcount *= pixel_size;\n\n\t\t\t\t\t\tfor ( i = 0; i < count; ++ i ) {\n\n\t\t\t\t\t\t\tpixel_data[ shift + i ] = data[ offset ++ ];\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tshift += count;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t } else {\n\n\t\t\t\t// raw pixels\n\n\t\t\t\tpixel_data = data.subarray(\n\t\t\t\t\t offset, offset += ( use_pal ? header.width * header.height : pixel_total )\n\t\t\t\t);\n\n\t\t\t }\n\n\t\t\t return {\n\t\t\t\tpixel_data: pixel_data,\n\t\t\t\tpalettes: palettes\n\t\t\t };\n\n\t\t}\n\n\t\tfunction tgaGetImageData8bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image, palettes ) {\n\n\t\t\tconst colormap = palettes;\n\t\t\tlet color, i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i ++ ) {\n\n\t\t\t\t\tcolor = image[ i ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = 255;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = colormap[ ( color * 3 ) + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = colormap[ ( color * 3 ) + 1 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = colormap[ ( color * 3 ) + 2 ];\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction tgaGetImageData16bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image ) {\n\n\t\t\tlet color, i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i += 2 ) {\n\n\t\t\t\t\tcolor = image[ i + 0 ] + ( image[ i + 1 ] << 8 ); // Inversed ?\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = ( color & 0x7C00 ) >> 7;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = ( color & 0x03E0 ) >> 2;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = ( color & 0x001F ) >> 3;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = ( color & 0x8000 ) ? 0 : 255;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction tgaGetImageData24bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image ) {\n\n\t\t\tlet i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i += 3 ) {\n\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = 255;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = image[ i + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = image[ i + 1 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = image[ i + 2 ];\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction tgaGetImageData32bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image ) {\n\n\t\t\tlet i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i += 4 ) {\n\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = image[ i + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = image[ i + 1 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = image[ i + 2 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = image[ i + 3 ];\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction tgaGetImageDataGrey8bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image ) {\n\n\t\t\tlet color, i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i ++ ) {\n\n\t\t\t\t\tcolor = image[ i ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = color;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = color;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = color;\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = 255;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction tgaGetImageDataGrey16bits( imageData, y_start, y_step, y_end, x_start, x_step, x_end, image ) {\n\n\t\t\tlet i = 0, x, y;\n\t\t\tconst width = header.width;\n\n\t\t\tfor ( y = y_start; y !== y_end; y += y_step ) {\n\n\t\t\t\tfor ( x = x_start; x !== x_end; x += x_step, i += 2 ) {\n\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 0 ] = image[ i + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 1 ] = image[ i + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 2 ] = image[ i + 0 ];\n\t\t\t\t\timageData[ ( x + width * y ) * 4 + 3 ] = image[ i + 1 ];\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn imageData;\n\n\t\t}\n\n\t\tfunction getTgaRGBA( data, width, height, image, palette ) {\n\n\t\t\tlet x_start,\n\t\t\t\ty_start,\n\t\t\t\tx_step,\n\t\t\t\ty_step,\n\t\t\t\tx_end,\n\t\t\t\ty_end;\n\n\t\t\tswitch ( ( header.flags & TGA_ORIGIN_MASK ) >> TGA_ORIGIN_SHIFT ) {\n\n\t\t\t\tdefault:\n\t\t\t\tcase TGA_ORIGIN_UL:\n\t\t\t\t\tx_start = 0;\n\t\t\t\t\tx_step = 1;\n\t\t\t\t\tx_end = width;\n\t\t\t\t\ty_start = 0;\n\t\t\t\t\ty_step = 1;\n\t\t\t\t\ty_end = height;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase TGA_ORIGIN_BL:\n\t\t\t\t\tx_start = 0;\n\t\t\t\t\tx_step = 1;\n\t\t\t\t\tx_end = width;\n\t\t\t\t\ty_start = height - 1;\n\t\t\t\t\ty_step = - 1;\n\t\t\t\t\ty_end = - 1;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase TGA_ORIGIN_UR:\n\t\t\t\t\tx_start = width - 1;\n\t\t\t\t\tx_step = - 1;\n\t\t\t\t\tx_end = - 1;\n\t\t\t\t\ty_start = 0;\n\t\t\t\t\ty_step = 1;\n\t\t\t\t\ty_end = height;\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase TGA_ORIGIN_BR:\n\t\t\t\t\tx_start = width - 1;\n\t\t\t\t\tx_step = - 1;\n\t\t\t\t\tx_end = - 1;\n\t\t\t\t\ty_start = height - 1;\n\t\t\t\t\ty_step = - 1;\n\t\t\t\t\ty_end = - 1;\n\t\t\t\t\tbreak;\n\n\t\t\t}\n\n\t\t\tif ( use_grey ) {\n\n\t\t\t\tswitch ( header.pixel_size ) {\n\n\t\t\t\t\tcase 8:\n\t\t\t\t\t\ttgaGetImageDataGrey8bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 16:\n\t\t\t\t\t\ttgaGetImageDataGrey16bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tconsole.error( 'THREE.TGALoader: Format not supported.' );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t} else {\n\n\t\t\t\tswitch ( header.pixel_size ) {\n\n\t\t\t\t\tcase 8:\n\t\t\t\t\t\ttgaGetImageData8bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image, palette );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 16:\n\t\t\t\t\t\ttgaGetImageData16bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 24:\n\t\t\t\t\t\ttgaGetImageData24bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tcase 32:\n\t\t\t\t\t\ttgaGetImageData32bits( data, y_start, y_step, y_end, x_start, x_step, x_end, image );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tconsole.error( 'THREE.TGALoader: Format not supported.' );\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// Load image data according to specific method\n\t\t\t// let func = 'tgaGetImageData' + (use_grey ? 'Grey' : '') + (header.pixel_size) + 'bits';\n\t\t\t// func(data, y_start, y_step, y_end, x_start, x_step, x_end, width, image, palette );\n\t\t\treturn data;\n\n\t\t}\n\n\t\t// TGA constants\n\n\t\tconst TGA_TYPE_NO_DATA = 0,\n\t\t\tTGA_TYPE_INDEXED = 1,\n\t\t\tTGA_TYPE_RGB = 2,\n\t\t\tTGA_TYPE_GREY = 3,\n\t\t\tTGA_TYPE_RLE_INDEXED = 9,\n\t\t\tTGA_TYPE_RLE_RGB = 10,\n\t\t\tTGA_TYPE_RLE_GREY = 11,\n\n\t\t\tTGA_ORIGIN_MASK = 0x30,\n\t\t\tTGA_ORIGIN_SHIFT = 0x04,\n\t\t\tTGA_ORIGIN_BL = 0x00,\n\t\t\tTGA_ORIGIN_BR = 0x01,\n\t\t\tTGA_ORIGIN_UL = 0x02,\n\t\t\tTGA_ORIGIN_UR = 0x03;\n\n\t\tif ( buffer.length < 19 ) console.error( 'THREE.TGALoader: Not enough data to contain header.' );\n\n\t\tlet offset = 0;\n\n\t\tconst content = new Uint8Array( buffer ),\n\t\t\theader = {\n\t\t\t\tid_length: content[ offset ++ ],\n\t\t\t\tcolormap_type: content[ offset ++ ],\n\t\t\t\timage_type: content[ offset ++ ],\n\t\t\t\tcolormap_index: content[ offset ++ ] | content[ offset ++ ] << 8,\n\t\t\t\tcolormap_length: content[ offset ++ ] | content[ offset ++ ] << 8,\n\t\t\t\tcolormap_size: content[ offset ++ ],\n\t\t\t\torigin: [\n\t\t\t\t\tcontent[ offset ++ ] | content[ offset ++ ] << 8,\n\t\t\t\t\tcontent[ offset ++ ] | content[ offset ++ ] << 8\n\t\t\t\t],\n\t\t\t\twidth: content[ offset ++ ] | content[ offset ++ ] << 8,\n\t\t\t\theight: content[ offset ++ ] | content[ offset ++ ] << 8,\n\t\t\t\tpixel_size: content[ offset ++ ],\n\t\t\t\tflags: content[ offset ++ ]\n\t\t\t};\n\n\t\t// check tga if it is valid format\n\n\t\ttgaCheckHeader( header );\n\n\t\tif ( header.id_length + offset > buffer.length ) {\n\n\t\t\tconsole.error( 'THREE.TGALoader: No data.' );\n\n\t\t}\n\n\t\t// skip the needn't data\n\n\t\toffset += header.id_length;\n\n\t\t// get targa information about RLE compression and palette\n\n\t\tlet use_rle = false,\n\t\t\tuse_pal = false,\n\t\t\tuse_grey = false;\n\n\t\tswitch ( header.image_type ) {\n\n\t\t\tcase TGA_TYPE_RLE_INDEXED:\n\t\t\t\tuse_rle = true;\n\t\t\t\tuse_pal = true;\n\t\t\t\tbreak;\n\n\t\t\tcase TGA_TYPE_INDEXED:\n\t\t\t\tuse_pal = true;\n\t\t\t\tbreak;\n\n\t\t\tcase TGA_TYPE_RLE_RGB:\n\t\t\t\tuse_rle = true;\n\t\t\t\tbreak;\n\n\t\t\tcase TGA_TYPE_RGB:\n\t\t\t\tbreak;\n\n\t\t\tcase TGA_TYPE_RLE_GREY:\n\t\t\t\tuse_rle = true;\n\t\t\t\tuse_grey = true;\n\t\t\t\tbreak;\n\n\t\t\tcase TGA_TYPE_GREY:\n\t\t\t\tuse_grey = true;\n\t\t\t\tbreak;\n\n\t\t}\n\n\t\t//\n\n\t\tconst imageData = new Uint8Array( header.width * header.height * 4 );\n\t\tconst result = tgaParse( use_rle, use_pal, header, offset, content );\n\t\tgetTgaRGBA( imageData, header.width, header.height, result.pixel_data, result.palettes );\n\n\t\treturn {\n\n\t\t\tdata: imageData,\n\t\t\twidth: header.width,\n\t\t\theight: header.height,\n\t\t\tflipY: true,\n\t\t\tgenerateMipmaps: true,\n\t\t\tminFilter: LinearMipmapLinearFilter,\n\n\t\t};\n\n\t}\n\n}\n\nexport { TGALoader };\n","import {\n\tAddOperation,\n\tAnimationClip,\n\tBone,\n\tBufferGeometry,\n\tColor,\n\tCustomBlending,\n\tDoubleSide,\n\tDstAlphaFactor,\n\tEuler,\n\tFileLoader,\n\tFloat32BufferAttribute,\n\tFrontSide,\n\tInterpolant,\n\tLoader,\n\tLoaderUtils,\n\tMeshToonMaterial,\n\tMultiplyOperation,\n\tNearestFilter,\n\tNumberKeyframeTrack,\n\tOneMinusSrcAlphaFactor,\n\tQuaternion,\n\tQuaternionKeyframeTrack,\n\tRepeatWrapping,\n\tSkeleton,\n\tSkinnedMesh,\n\tSrcAlphaFactor,\n\tTextureLoader,\n\tUint16BufferAttribute,\n\tVector3,\n\tVectorKeyframeTrack\n} from 'three';\nimport { TGALoader } from '../loaders/TGALoader.js';\nimport { MMDParser } from '../libs/mmdparser.module.js';\n\n/**\n * Dependencies\n *  - mmd-parser https://github.com/takahirox/mmd-parser\n *  - TGALoader\n *  - OutlineEffect\n *\n * MMDLoader creates Three.js Objects from MMD resources as\n * PMD, PMX, VMD, and VPD files.\n *\n * PMD/PMX is a model data format, VMD is a motion data format\n * VPD is a posing data format used in MMD(Miku Miku Dance).\n *\n * MMD official site\n *  - https://sites.google.com/view/evpvp/\n *\n * PMD, VMD format (in Japanese)\n *  - http://blog.goo.ne.jp/torisu_tetosuki/e/209ad341d3ece2b1b4df24abf619d6e4\n *\n * PMX format\n *  - https://gist.github.com/felixjones/f8a06bd48f9da9a4539f\n *\n * TODO\n *  - light motion in vmd support.\n *  - SDEF support.\n *  - uv/material/bone morphing support.\n *  - more precise grant skinning support.\n *  - shadow support.\n */\n\n/**\n * @param {THREE.LoadingManager} manager\n */\nclass MMDLoader extends Loader {\n\n\tconstructor( manager ) {\n\n\t\tsuper( manager );\n\n\t\tthis.loader = new FileLoader( this.manager );\n\n\t\tthis.parser = null; // lazy generation\n\t\tthis.meshBuilder = new MeshBuilder( this.manager );\n\t\tthis.animationBuilder = new AnimationBuilder();\n\n\t}\n\n\t/**\n\t * @param {string} animationPath\n\t * @return {MMDLoader}\n\t */\n\tsetAnimationPath( animationPath ) {\n\n\t\tthis.animationPath = animationPath;\n\t\treturn this;\n\n\t}\n\n\t// Load MMD assets as Three.js Object\n\n\t/**\n\t * Loads Model file (.pmd or .pmx) as a SkinnedMesh.\n\t *\n\t * @param {string} url - url to Model(.pmd or .pmx) file\n\t * @param {function} onLoad\n\t * @param {function} onProgress\n\t * @param {function} onError\n\t */\n\tload( url, onLoad, onProgress, onError ) {\n\n\t\tconst builder = this.meshBuilder.setCrossOrigin( this.crossOrigin );\n\n\t\t// resource path\n\n\t\tlet resourcePath;\n\n\t\tif ( this.resourcePath !== '' ) {\n\n\t\t\tresourcePath = this.resourcePath;\n\n\t\t} else if ( this.path !== '' ) {\n\n\t\t\tresourcePath = this.path;\n\n\t\t} else {\n\n\t\t\tresourcePath = LoaderUtils.extractUrlBase( url );\n\n\t\t}\n\n\t\tconst modelExtension = this._extractExtension( url ).toLowerCase();\n\n\t\t// Should I detect by seeing header?\n\t\tif ( modelExtension !== 'pmd' && modelExtension !== 'pmx' ) {\n\n\t\t\tif ( onError ) onError( new Error( 'THREE.MMDLoader: Unknown model file extension .' + modelExtension + '.' ) );\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tthis[ modelExtension === 'pmd' ? 'loadPMD' : 'loadPMX' ]( url, function ( data ) {\n\n\t\t\tonLoad(\tbuilder.build( data, resourcePath, onProgress, onError )\t);\n\n\t\t}, onProgress, onError );\n\n\t}\n\n\t/**\n\t * Loads Motion file(s) (.vmd) as a AnimationClip.\n\t * If two or more files are specified, they'll be merged.\n\t *\n\t * @param {string|Array<string>} url - url(s) to animation(.vmd) file(s)\n\t * @param {SkinnedMesh|THREE.Camera} object - tracks will be fitting to this object\n\t * @param {function} onLoad\n\t * @param {function} onProgress\n\t * @param {function} onError\n\t */\n\tloadAnimation( url, object, onLoad, onProgress, onError ) {\n\n\t\tconst builder = this.animationBuilder;\n\n\t\tthis.loadVMD( url, function ( vmd ) {\n\n\t\t\tonLoad( object.isCamera\n\t\t\t\t? builder.buildCameraAnimation( vmd )\n\t\t\t\t: builder.build( vmd, object ) );\n\n\t\t}, onProgress, onError );\n\n\t}\n\n\t/**\n\t * Loads mode file and motion file(s) as an object containing\n\t * a SkinnedMesh and a AnimationClip.\n\t * Tracks of AnimationClip are fitting to the model.\n\t *\n\t * @param {string} modelUrl - url to Model(.pmd or .pmx) file\n\t * @param {string|Array{string}} vmdUrl - url(s) to animation(.vmd) file\n\t * @param {function} onLoad\n\t * @param {function} onProgress\n\t * @param {function} onError\n\t */\n\tloadWithAnimation( modelUrl, vmdUrl, onLoad, onProgress, onError ) {\n\n\t\tconst scope = this;\n\n\t\tthis.load( modelUrl, function ( mesh ) {\n\n\t\t\tscope.loadAnimation( vmdUrl, mesh, function ( animation ) {\n\n\t\t\t\tonLoad( {\n\t\t\t\t\tmesh: mesh,\n\t\t\t\t\tanimation: animation\n\t\t\t\t} );\n\n\t\t\t}, onProgress, onError );\n\n\t\t}, onProgress, onError );\n\n\t}\n\n\t// Load MMD assets as Object data parsed by MMDParser\n\n\t/**\n\t * Loads .pmd file as an Object.\n\t *\n\t * @param {string} url - url to .pmd file\n\t * @param {function} onLoad\n\t * @param {function} onProgress\n\t * @param {function} onError\n\t */\n\tloadPMD( url, onLoad, onProgress, onError ) {\n\n\t\tconst parser = this._getParser();\n\n\t\tthis.loader\n\t\t\t.setMimeType( undefined )\n\t\t\t.setPath( this.path )\n\t\t\t.setResponseType( 'arraybuffer' )\n\t\t\t.setRequestHeader( this.requestHeader )\n\t\t\t.setWithCredentials( this.withCredentials )\n\t\t\t.load( url, function ( buffer ) {\n\n\t\t\t\tonLoad( parser.parsePmd( buffer, true ) );\n\n\t\t\t}, onProgress, onError );\n\n\t}\n\n\t/**\n\t * Loads .pmx file as an Object.\n\t *\n\t * @param {string} url - url to .pmx file\n\t * @param {function} onLoad\n\t * @param {function} onProgress\n\t * @param {function} onError\n\t */\n\tloadPMX( url, onLoad, onProgress, onError ) {\n\n\t\tconst parser = this._getParser();\n\n\t\tthis.loader\n\t\t\t.setMimeType( undefined )\n\t\t\t.setPath( this.path )\n\t\t\t.setResponseType( 'arraybuffer' )\n\t\t\t.setRequestHeader( this.requestHeader )\n\t\t\t.setWithCredentials( this.withCredentials )\n\t\t\t.load( url, function ( buffer ) {\n\n\t\t\t\tonLoad( parser.parsePmx( buffer, true ) );\n\n\t\t\t}, onProgress, onError );\n\n\t}\n\n\t/**\n\t * Loads .vmd file as an Object. If two or more files are specified\n\t * they'll be merged.\n\t *\n\t * @param {string|Array<string>} url - url(s) to .vmd file(s)\n\t * @param {function} onLoad\n\t * @param {function} onProgress\n\t * @param {function} onError\n\t */\n\tloadVMD( url, onLoad, onProgress, onError ) {\n\n\t\tconst urls = Array.isArray( url ) ? url : [ url ];\n\n\t\tconst vmds = [];\n\t\tconst vmdNum = urls.length;\n\n\t\tconst parser = this._getParser();\n\n\t\tthis.loader\n\t\t\t.setMimeType( undefined )\n\t\t\t.setPath( this.animationPath )\n\t\t\t.setResponseType( 'arraybuffer' )\n\t\t\t.setRequestHeader( this.requestHeader )\n\t\t\t.setWithCredentials( this.withCredentials );\n\n\t\tfor ( let i = 0, il = urls.length; i < il; i ++ ) {\n\n\t\t\tthis.loader.load( urls[ i ], function ( buffer ) {\n\n\t\t\t\tvmds.push( parser.parseVmd( buffer, true ) );\n\n\t\t\t\tif ( vmds.length === vmdNum ) onLoad( parser.mergeVmds( vmds ) );\n\n\t\t\t}, onProgress, onError );\n\n\t\t}\n\n\t}\n\n\t/**\n\t * Loads .vpd file as an Object.\n\t *\n\t * @param {string} url - url to .vpd file\n\t * @param {boolean} isUnicode\n\t * @param {function} onLoad\n\t * @param {function} onProgress\n\t * @param {function} onError\n\t */\n\tloadVPD( url, isUnicode, onLoad, onProgress, onError ) {\n\n\t\tconst parser = this._getParser();\n\n\t\tthis.loader\n\t\t\t.setMimeType( isUnicode ? undefined : 'text/plain; charset=shift_jis' )\n\t\t\t.setPath( this.animationPath )\n\t\t\t.setResponseType( 'text' )\n\t\t\t.setRequestHeader( this.requestHeader )\n\t\t\t.setWithCredentials( this.withCredentials )\n\t\t\t.load( url, function ( text ) {\n\n\t\t\t\tonLoad( parser.parseVpd( text, true ) );\n\n\t\t\t}, onProgress, onError );\n\n\t}\n\n\t// private methods\n\n\t_extractExtension( url ) {\n\n\t\tconst index = url.lastIndexOf( '.' );\n\t\treturn index < 0 ? '' : url.slice( index + 1 );\n\n\t}\n\n\t_getParser() {\n\n\t\tif ( this.parser === null ) {\n\n\t\t\tif ( typeof MMDParser === 'undefined' ) {\n\n\t\t\t\tthrow new Error( 'THREE.MMDLoader: Import MMDParser https://github.com/takahirox/mmd-parser' );\n\n\t\t\t}\n\n\t\t\tthis.parser = new MMDParser.Parser(); // eslint-disable-line no-undef\n\n\t\t}\n\n\t\treturn this.parser;\n\n\t}\n\n}\n\n// Utilities\n\n/*\n\t * base64 encoded defalut toon textures toon00.bmp - toon10.bmp.\n\t * We don't need to request external toon image files.\n\t * This idea is from http://www20.atpages.jp/katwat/three.js_r58/examples/mytest37/mmd.three.js\n\t */\nconst DEFAULT_TOON_TEXTURES = [\n\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\n\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==',\n\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC',\n\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==',\n\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==',\n\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=',\n\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=',\n\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\n\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\n\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\n\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII='\n];\n\n// Builders. They build Three.js object from Object data parsed by MMDParser.\n\n/**\n * @param {THREE.LoadingManager} manager\n */\nclass MeshBuilder {\n\n\tconstructor( manager ) {\n\n\t\tthis.crossOrigin = 'anonymous';\n\t\tthis.geometryBuilder = new GeometryBuilder();\n\t\tthis.materialBuilder = new MaterialBuilder( manager );\n\n\t}\n\n\t/**\n\t * @param {string} crossOrigin\n\t * @return {MeshBuilder}\n\t */\n\tsetCrossOrigin( crossOrigin ) {\n\n\t\tthis.crossOrigin = crossOrigin;\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * @param {Object} data - parsed PMD/PMX data\n\t * @param {string} resourcePath\n\t * @param {function} onProgress\n\t * @param {function} onError\n\t * @return {SkinnedMesh}\n\t */\n\tbuild( data, resourcePath, onProgress, onError ) {\n\n\t\tconst geometry = this.geometryBuilder.build( data );\n\t\tconst material = this.materialBuilder\n\t\t\t.setCrossOrigin( this.crossOrigin )\n\t\t\t.setResourcePath( resourcePath )\n\t\t\t.build( data, geometry, onProgress, onError );\n\n\t\tconst mesh = new SkinnedMesh( geometry, material );\n\n\t\tconst skeleton = new Skeleton( initBones( mesh ) );\n\t\tmesh.bind( skeleton );\n\n\t\t// console.log( mesh ); // for console debug\n\n\t\treturn mesh;\n\n\t}\n\n}\n\n// TODO: Try to remove this function\n\nfunction initBones( mesh ) {\n\n\tconst geometry = mesh.geometry;\n\n\tconst bones = [];\n\n\tif ( geometry && geometry.bones !== undefined ) {\n\n\t\t// first, create array of 'Bone' objects from geometry data\n\n\t\tfor ( let i = 0, il = geometry.bones.length; i < il; i ++ ) {\n\n\t\t\tconst gbone = geometry.bones[ i ];\n\n\t\t\t// create new 'Bone' object\n\n\t\t\tconst bone = new Bone();\n\t\t\tbones.push( bone );\n\n\t\t\t// apply values\n\n\t\t\tbone.name = gbone.name;\n\t\t\tbone.position.fromArray( gbone.pos );\n\t\t\tbone.quaternion.fromArray( gbone.rotq );\n\t\t\tif ( gbone.scl !== undefined ) bone.scale.fromArray( gbone.scl );\n\n\t\t}\n\n\t\t// second, create bone hierarchy\n\n\t\tfor ( let i = 0, il = geometry.bones.length; i < il; i ++ ) {\n\n\t\t\tconst gbone = geometry.bones[ i ];\n\n\t\t\tif ( ( gbone.parent !== - 1 ) && ( gbone.parent !== null ) && ( bones[ gbone.parent ] !== undefined ) ) {\n\n\t\t\t\t// subsequent bones in the hierarchy\n\n\t\t\t\tbones[ gbone.parent ].add( bones[ i ] );\n\n\t\t\t} else {\n\n\t\t\t\t// topmost bone, immediate child of the skinned mesh\n\n\t\t\t\tmesh.add( bones[ i ] );\n\n\t\t\t}\n\n\t\t}\n\n\t}\n\n\t// now the bones are part of the scene graph and children of the skinned mesh.\n\t// let's update the corresponding matrices\n\n\tmesh.updateMatrixWorld( true );\n\n\treturn bones;\n\n}\n\n//\n\nclass GeometryBuilder {\n\n\t/**\n\t * @param {Object} data - parsed PMD/PMX data\n\t * @return {BufferGeometry}\n\t */\n\tbuild( data ) {\n\n\t\t// for geometry\n\t\tconst positions = [];\n\t\tconst uvs = [];\n\t\tconst normals = [];\n\n\t\tconst indices = [];\n\n\t\tconst groups = [];\n\n\t\tconst bones = [];\n\t\tconst skinIndices = [];\n\t\tconst skinWeights = [];\n\n\t\tconst morphTargets = [];\n\t\tconst morphPositions = [];\n\n\t\tconst iks = [];\n\t\tconst grants = [];\n\n\t\tconst rigidBodies = [];\n\t\tconst constraints = [];\n\n\t\t// for work\n\t\tlet offset = 0;\n\t\tconst boneTypeTable = {};\n\n\t\t// positions, normals, uvs, skinIndices, skinWeights\n\n\t\tfor ( let i = 0; i < data.metadata.vertexCount; i ++ ) {\n\n\t\t\tconst v = data.vertices[ i ];\n\n\t\t\tfor ( let j = 0, jl = v.position.length; j < jl; j ++ ) {\n\n\t\t\t\tpositions.push( v.position[ j ] );\n\n\t\t\t}\n\n\t\t\tfor ( let j = 0, jl = v.normal.length; j < jl; j ++ ) {\n\n\t\t\t\tnormals.push( v.normal[ j ] );\n\n\t\t\t}\n\n\t\t\tfor ( let j = 0, jl = v.uv.length; j < jl; j ++ ) {\n\n\t\t\t\tuvs.push( v.uv[ j ] );\n\n\t\t\t}\n\n\t\t\tfor ( let j = 0; j < 4; j ++ ) {\n\n\t\t\t\tskinIndices.push( v.skinIndices.length - 1 >= j ? v.skinIndices[ j ] : 0.0 );\n\n\t\t\t}\n\n\t\t\tfor ( let j = 0; j < 4; j ++ ) {\n\n\t\t\t\tskinWeights.push( v.skinWeights.length - 1 >= j ? v.skinWeights[ j ] : 0.0 );\n\n\t\t\t}\n\n\t\t}\n\n\t\t// indices\n\n\t\tfor ( let i = 0; i < data.metadata.faceCount; i ++ ) {\n\n\t\t\tconst face = data.faces[ i ];\n\n\t\t\tfor ( let j = 0, jl = face.indices.length; j < jl; j ++ ) {\n\n\t\t\t\tindices.push( face.indices[ j ] );\n\n\t\t\t}\n\n\t\t}\n\n\t\t// groups\n\n\t\tfor ( let i = 0; i < data.metadata.materialCount; i ++ ) {\n\n\t\t\tconst material = data.materials[ i ];\n\n\t\t\tgroups.push( {\n\t\t\t\toffset: offset * 3,\n\t\t\t\tcount: material.faceCount * 3\n\t\t\t} );\n\n\t\t\toffset += material.faceCount;\n\n\t\t}\n\n\t\t// bones\n\n\t\tfor ( let i = 0; i < data.metadata.rigidBodyCount; i ++ ) {\n\n\t\t\tconst body = data.rigidBodies[ i ];\n\t\t\tlet value = boneTypeTable[ body.boneIndex ];\n\n\t\t\t// keeps greater number if already value is set without any special reasons\n\t\t\tvalue = value === undefined ? body.type : Math.max( body.type, value );\n\n\t\t\tboneTypeTable[ body.boneIndex ] = value;\n\n\t\t}\n\n\t\tfor ( let i = 0; i < data.metadata.boneCount; i ++ ) {\n\n\t\t\tconst boneData = data.bones[ i ];\n\n\t\t\tconst bone = {\n\t\t\t\tindex: i,\n\t\t\t\ttransformationClass: boneData.transformationClass,\n\t\t\t\tparent: boneData.parentIndex,\n\t\t\t\tname: boneData.name,\n\t\t\t\tpos: boneData.position.slice( 0, 3 ),\n\t\t\t\trotq: [ 0, 0, 0, 1 ],\n\t\t\t\tscl: [ 1, 1, 1 ],\n\t\t\t\trigidBodyType: boneTypeTable[ i ] !== undefined ? boneTypeTable[ i ] : - 1\n\t\t\t};\n\n\t\t\tif ( bone.parent !== - 1 ) {\n\n\t\t\t\tbone.pos[ 0 ] -= data.bones[ bone.parent ].position[ 0 ];\n\t\t\t\tbone.pos[ 1 ] -= data.bones[ bone.parent ].position[ 1 ];\n\t\t\t\tbone.pos[ 2 ] -= data.bones[ bone.parent ].position[ 2 ];\n\n\t\t\t}\n\n\t\t\tbones.push( bone );\n\n\t\t}\n\n\t\t// iks\n\n\t\t// TODO: remove duplicated codes between PMD and PMX\n\t\tif ( data.metadata.format === 'pmd' ) {\n\n\t\t\tfor ( let i = 0; i < data.metadata.ikCount; i ++ ) {\n\n\t\t\t\tconst ik = data.iks[ i ];\n\n\t\t\t\tconst param = {\n\t\t\t\t\ttarget: ik.target,\n\t\t\t\t\teffector: ik.effector,\n\t\t\t\t\titeration: ik.iteration,\n\t\t\t\t\tmaxAngle: ik.maxAngle * 4,\n\t\t\t\t\tlinks: []\n\t\t\t\t};\n\n\t\t\t\tfor ( let j = 0, jl = ik.links.length; j < jl; j ++ ) {\n\n\t\t\t\t\tconst link = {};\n\t\t\t\t\tlink.index = ik.links[ j ].index;\n\t\t\t\t\tlink.enabled = true;\n\n\t\t\t\t\tif ( data.bones[ link.index ].name.indexOf( '' ) >= 0 ) {\n\n\t\t\t\t\t\tlink.limitation = new Vector3( 1.0, 0.0, 0.0 );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tparam.links.push( link );\n\n\t\t\t\t}\n\n\t\t\t\tiks.push( param );\n\n\t\t\t}\n\n\t\t} else {\n\n\t\t\tfor ( let i = 0; i < data.metadata.boneCount; i ++ ) {\n\n\t\t\t\tconst ik = data.bones[ i ].ik;\n\n\t\t\t\tif ( ik === undefined ) continue;\n\n\t\t\t\tconst param = {\n\t\t\t\t\ttarget: i,\n\t\t\t\t\teffector: ik.effector,\n\t\t\t\t\titeration: ik.iteration,\n\t\t\t\t\tmaxAngle: ik.maxAngle,\n\t\t\t\t\tlinks: []\n\t\t\t\t};\n\n\t\t\t\tfor ( let j = 0, jl = ik.links.length; j < jl; j ++ ) {\n\n\t\t\t\t\tconst link = {};\n\t\t\t\t\tlink.index = ik.links[ j ].index;\n\t\t\t\t\tlink.enabled = true;\n\n\t\t\t\t\tif ( ik.links[ j ].angleLimitation === 1 ) {\n\n\t\t\t\t\t\t// Revert if rotationMin/Max doesn't work well\n\t\t\t\t\t\t// link.limitation = new Vector3( 1.0, 0.0, 0.0 );\n\n\t\t\t\t\t\tconst rotationMin = ik.links[ j ].lowerLimitationAngle;\n\t\t\t\t\t\tconst rotationMax = ik.links[ j ].upperLimitationAngle;\n\n\t\t\t\t\t\t// Convert Left to Right coordinate by myself because\n\t\t\t\t\t\t// MMDParser doesn't convert. It's a MMDParser's bug\n\n\t\t\t\t\t\tconst tmp1 = - rotationMax[ 0 ];\n\t\t\t\t\t\tconst tmp2 = - rotationMax[ 1 ];\n\t\t\t\t\t\trotationMax[ 0 ] = - rotationMin[ 0 ];\n\t\t\t\t\t\trotationMax[ 1 ] = - rotationMin[ 1 ];\n\t\t\t\t\t\trotationMin[ 0 ] = tmp1;\n\t\t\t\t\t\trotationMin[ 1 ] = tmp2;\n\n\t\t\t\t\t\tlink.rotationMin = new Vector3().fromArray( rotationMin );\n\t\t\t\t\t\tlink.rotationMax = new Vector3().fromArray( rotationMax );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tparam.links.push( link );\n\n\t\t\t\t}\n\n\t\t\t\tiks.push( param );\n\n\t\t\t\t// Save the reference even from bone data for efficiently\n\t\t\t\t// simulating PMX animation system\n\t\t\t\tbones[ i ].ik = param;\n\n\t\t\t}\n\n\t\t}\n\n\t\t// grants\n\n\t\tif ( data.metadata.format === 'pmx' ) {\n\n\t\t\t// bone index -> grant entry map\n\t\t\tconst grantEntryMap = {};\n\n\t\t\tfor ( let i = 0; i < data.metadata.boneCount; i ++ ) {\n\n\t\t\t\tconst boneData = data.bones[ i ];\n\t\t\t\tconst grant = boneData.grant;\n\n\t\t\t\tif ( grant === undefined ) continue;\n\n\t\t\t\tconst param = {\n\t\t\t\t\tindex: i,\n\t\t\t\t\tparentIndex: grant.parentIndex,\n\t\t\t\t\tratio: grant.ratio,\n\t\t\t\t\tisLocal: grant.isLocal,\n\t\t\t\t\taffectRotation: grant.affectRotation,\n\t\t\t\t\taffectPosition: grant.affectPosition,\n\t\t\t\t\ttransformationClass: boneData.transformationClass\n\t\t\t\t};\n\n\t\t\t\tgrantEntryMap[ i ] = { parent: null, children: [], param: param, visited: false };\n\n\t\t\t}\n\n\t\t\tconst rootEntry = { parent: null, children: [], param: null, visited: false };\n\n\t\t\t// Build a tree representing grant hierarchy\n\n\t\t\tfor ( const boneIndex in grantEntryMap ) {\n\n\t\t\t\tconst grantEntry = grantEntryMap[ boneIndex ];\n\t\t\t\tconst parentGrantEntry = grantEntryMap[ grantEntry.parentIndex ] || rootEntry;\n\n\t\t\t\tgrantEntry.parent = parentGrantEntry;\n\t\t\t\tparentGrantEntry.children.push( grantEntry );\n\n\t\t\t}\n\n\t\t\t// Sort grant parameters from parents to children because\n\t\t\t// grant uses parent's transform that parent's grant is already applied\n\t\t\t// so grant should be applied in order from parents to children\n\n\t\t\tfunction traverse( entry ) {\n\n\t\t\t\tif ( entry.param ) {\n\n\t\t\t\t\tgrants.push( entry.param );\n\n\t\t\t\t\t// Save the reference even from bone data for efficiently\n\t\t\t\t\t// simulating PMX animation system\n\t\t\t\t\tbones[ entry.param.index ].grant = entry.param;\n\n\t\t\t\t}\n\n\t\t\t\tentry.visited = true;\n\n\t\t\t\tfor ( let i = 0, il = entry.children.length; i < il; i ++ ) {\n\n\t\t\t\t\tconst child = entry.children[ i ];\n\n\t\t\t\t\t// Cut off a loop if exists. (Is a grant loop invalid?)\n\t\t\t\t\tif ( ! child.visited ) traverse( child );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\ttraverse( rootEntry );\n\n\t\t}\n\n\t\t// morph\n\n\t\tfunction updateAttributes( attribute, morph, ratio ) {\n\n\t\t\tfor ( let i = 0; i < morph.elementCount; i ++ ) {\n\n\t\t\t\tconst element = morph.elements[ i ];\n\n\t\t\t\tlet index;\n\n\t\t\t\tif ( data.metadata.format === 'pmd' ) {\n\n\t\t\t\t\tindex = data.morphs[ 0 ].elements[ element.index ].index;\n\n\t\t\t\t} else {\n\n\t\t\t\t\tindex = element.index;\n\n\t\t\t\t}\n\n\t\t\t\tattribute.array[ index * 3 + 0 ] += element.position[ 0 ] * ratio;\n\t\t\t\tattribute.array[ index * 3 + 1 ] += element.position[ 1 ] * ratio;\n\t\t\t\tattribute.array[ index * 3 + 2 ] += element.position[ 2 ] * ratio;\n\n\t\t\t}\n\n\t\t}\n\n\t\tfor ( let i = 0; i < data.metadata.morphCount; i ++ ) {\n\n\t\t\tconst morph = data.morphs[ i ];\n\t\t\tconst params = { name: morph.name };\n\n\t\t\tconst attribute = new Float32BufferAttribute( data.metadata.vertexCount * 3, 3 );\n\t\t\tattribute.name = morph.name;\n\n\t\t\tfor ( let j = 0; j < data.metadata.vertexCount * 3; j ++ ) {\n\n\t\t\t\tattribute.array[ j ] = positions[ j ];\n\n\t\t\t}\n\n\t\t\tif ( data.metadata.format === 'pmd' ) {\n\n\t\t\t\tif ( i !== 0 ) {\n\n\t\t\t\t\tupdateAttributes( attribute, morph, 1.0 );\n\n\t\t\t\t}\n\n\t\t\t} else {\n\n\t\t\t\tif ( morph.type === 0 ) { // group\n\n\t\t\t\t\tfor ( let j = 0; j < morph.elementCount; j ++ ) {\n\n\t\t\t\t\t\tconst morph2 = data.morphs[ morph.elements[ j ].index ];\n\t\t\t\t\t\tconst ratio = morph.elements[ j ].ratio;\n\n\t\t\t\t\t\tif ( morph2.type === 1 ) {\n\n\t\t\t\t\t\t\tupdateAttributes( attribute, morph2, ratio );\n\n\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\t// TODO: implement\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t} else if ( morph.type === 1 ) { // vertex\n\n\t\t\t\t\tupdateAttributes( attribute, morph, 1.0 );\n\n\t\t\t\t} else if ( morph.type === 2 ) { // bone\n\n\t\t\t\t\t// TODO: implement\n\n\t\t\t\t} else if ( morph.type === 3 ) { // uv\n\n\t\t\t\t\t// TODO: implement\n\n\t\t\t\t} else if ( morph.type === 4 ) { // additional uv1\n\n\t\t\t\t\t// TODO: implement\n\n\t\t\t\t} else if ( morph.type === 5 ) { // additional uv2\n\n\t\t\t\t\t// TODO: implement\n\n\t\t\t\t} else if ( morph.type === 6 ) { // additional uv3\n\n\t\t\t\t\t// TODO: implement\n\n\t\t\t\t} else if ( morph.type === 7 ) { // additional uv4\n\n\t\t\t\t\t// TODO: implement\n\n\t\t\t\t} else if ( morph.type === 8 ) { // material\n\n\t\t\t\t\t// TODO: implement\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tmorphTargets.push( params );\n\t\t\tmorphPositions.push( attribute );\n\n\t\t}\n\n\t\t// rigid bodies from rigidBodies field.\n\n\t\tfor ( let i = 0; i < data.metadata.rigidBodyCount; i ++ ) {\n\n\t\t\tconst rigidBody = data.rigidBodies[ i ];\n\t\t\tconst params = {};\n\n\t\t\tfor ( const key in rigidBody ) {\n\n\t\t\t\tparams[ key ] = rigidBody[ key ];\n\n\t\t\t}\n\n\t\t\t/*\n\t\t\t\t * RigidBody position parameter in PMX seems global position\n\t\t\t\t * while the one in PMD seems offset from corresponding bone.\n\t\t\t\t * So unify being offset.\n\t\t\t\t */\n\t\t\tif ( data.metadata.format === 'pmx' ) {\n\n\t\t\t\tif ( params.boneIndex !== - 1 ) {\n\n\t\t\t\t\tconst bone = data.bones[ params.boneIndex ];\n\t\t\t\t\tparams.position[ 0 ] -= bone.position[ 0 ];\n\t\t\t\t\tparams.position[ 1 ] -= bone.position[ 1 ];\n\t\t\t\t\tparams.position[ 2 ] -= bone.position[ 2 ];\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\trigidBodies.push( params );\n\n\t\t}\n\n\t\t// constraints from constraints field.\n\n\t\tfor ( let i = 0; i < data.metadata.constraintCount; i ++ ) {\n\n\t\t\tconst constraint = data.constraints[ i ];\n\t\t\tconst params = {};\n\n\t\t\tfor ( const key in constraint ) {\n\n\t\t\t\tparams[ key ] = constraint[ key ];\n\n\t\t\t}\n\n\t\t\tconst bodyA = rigidBodies[ params.rigidBodyIndex1 ];\n\t\t\tconst bodyB = rigidBodies[ params.rigidBodyIndex2 ];\n\n\t\t\t// Refer to http://www20.atpages.jp/katwat/wp/?p=4135\n\t\t\tif ( bodyA.type !== 0 && bodyB.type === 2 ) {\n\n\t\t\t\tif ( bodyA.boneIndex !== - 1 && bodyB.boneIndex !== - 1 &&\n\t\t\t\t\t     data.bones[ bodyB.boneIndex ].parentIndex === bodyA.boneIndex ) {\n\n\t\t\t\t\tbodyB.type = 1;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tconstraints.push( params );\n\n\t\t}\n\n\t\t// build BufferGeometry.\n\n\t\tconst geometry = new BufferGeometry();\n\n\t\tgeometry.setAttribute( 'position', new Float32BufferAttribute( positions, 3 ) );\n\t\tgeometry.setAttribute( 'normal', new Float32BufferAttribute( normals, 3 ) );\n\t\tgeometry.setAttribute( 'uv', new Float32BufferAttribute( uvs, 2 ) );\n\t\tgeometry.setAttribute( 'skinIndex', new Uint16BufferAttribute( skinIndices, 4 ) );\n\t\tgeometry.setAttribute( 'skinWeight', new Float32BufferAttribute( skinWeights, 4 ) );\n\t\tgeometry.setIndex( indices );\n\n\t\tfor ( let i = 0, il = groups.length; i < il; i ++ ) {\n\n\t\t\tgeometry.addGroup( groups[ i ].offset, groups[ i ].count, i );\n\n\t\t}\n\n\t\tgeometry.bones = bones;\n\n\t\tgeometry.morphTargets = morphTargets;\n\t\tgeometry.morphAttributes.position = morphPositions;\n\t\tgeometry.morphTargetsRelative = false;\n\n\t\tgeometry.userData.MMD = {\n\t\t\tbones: bones,\n\t\t\tiks: iks,\n\t\t\tgrants: grants,\n\t\t\trigidBodies: rigidBodies,\n\t\t\tconstraints: constraints,\n\t\t\tformat: data.metadata.format\n\t\t};\n\n\t\tgeometry.computeBoundingSphere();\n\n\t\treturn geometry;\n\n\t}\n\n}\n\n//\n\n/**\n * @param {THREE.LoadingManager} manager\n */\nclass MaterialBuilder {\n\n\tconstructor( manager ) {\n\n\t\tthis.manager = manager;\n\n\t\tthis.textureLoader = new TextureLoader( this.manager );\n\t\tthis.tgaLoader = null; // lazy generation\n\n\t\tthis.crossOrigin = 'anonymous';\n\t\tthis.resourcePath = undefined;\n\n\t}\n\n\t/**\n\t * @param {string} crossOrigin\n\t * @return {MaterialBuilder}\n\t */\n\tsetCrossOrigin( crossOrigin ) {\n\n\t\tthis.crossOrigin = crossOrigin;\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * @param {string} resourcePath\n\t * @return {MaterialBuilder}\n\t */\n\tsetResourcePath( resourcePath ) {\n\n\t\tthis.resourcePath = resourcePath;\n\t\treturn this;\n\n\t}\n\n\t/**\n\t * @param {Object} data - parsed PMD/PMX data\n\t * @param {BufferGeometry} geometry - some properties are dependend on geometry\n\t * @param {function} onProgress\n\t * @param {function} onError\n\t * @return {Array<MeshToonMaterial>}\n\t */\n\tbuild( data, geometry /*, onProgress, onError */ ) {\n\n\t\tconst materials = [];\n\n\t\tconst textures = {};\n\n\t\tthis.textureLoader.setCrossOrigin( this.crossOrigin );\n\n\t\t// materials\n\n\t\tfor ( let i = 0; i < data.metadata.materialCount; i ++ ) {\n\n\t\t\tconst material = data.materials[ i ];\n\n\t\t\tconst params = { userData: {} };\n\n\t\t\tif ( material.name !== undefined ) params.name = material.name;\n\n\t\t\t/*\n\t\t\t\t * Color\n\t\t\t\t *\n\t\t\t\t * MMD         MeshToonMaterial\n\t\t\t\t * diffuse  -  color\n\t\t\t\t * ambient  -  emissive * a\n\t\t\t\t *               (a = 1.0 without map texture or 0.2 with map texture)\n\t\t\t\t *\n\t\t\t\t * MeshToonMaterial doesn't have ambient. Set it to emissive instead.\n\t\t\t\t * It'll be too bright if material has map texture so using coef 0.2.\n\t\t\t\t */\n\t\t\tparams.color = new Color().fromArray( material.diffuse );\n\t\t\tparams.opacity = material.diffuse[ 3 ];\n\t\t\tparams.emissive = new Color().fromArray( material.ambient );\n\t\t\tparams.transparent = params.opacity !== 1.0;\n\n\t\t\t//\n\n\t\t\tparams.skinning = geometry.bones.length > 0 ? true : false;\n\t\t\tparams.morphTargets = geometry.morphTargets.length > 0 ? true : false;\n\t\t\tparams.fog = true;\n\n\t\t\t// blend\n\n\t\t\tparams.blending = CustomBlending;\n\t\t\tparams.blendSrc = SrcAlphaFactor;\n\t\t\tparams.blendDst = OneMinusSrcAlphaFactor;\n\t\t\tparams.blendSrcAlpha = SrcAlphaFactor;\n\t\t\tparams.blendDstAlpha = DstAlphaFactor;\n\n\t\t\t// side\n\n\t\t\tif ( data.metadata.format === 'pmx' && ( material.flag & 0x1 ) === 1 ) {\n\n\t\t\t\tparams.side = DoubleSide;\n\n\t\t\t} else {\n\n\t\t\t\tparams.side = params.opacity === 1.0 ? FrontSide : DoubleSide;\n\n\t\t\t}\n\n\t\t\tif ( data.metadata.format === 'pmd' ) {\n\n\t\t\t\t// map, envMap\n\n\t\t\t\tif ( material.fileName ) {\n\n\t\t\t\t\tconst fileName = material.fileName;\n\t\t\t\t\tconst fileNames = fileName.split( '*' );\n\n\t\t\t\t\t// fileNames[ 0 ]: mapFileName\n\t\t\t\t\t// fileNames[ 1 ]: envMapFileName( optional )\n\n\t\t\t\t\tparams.map = this._loadTexture( fileNames[ 0 ], textures );\n\n\t\t\t\t\tif ( fileNames.length > 1 ) {\n\n\t\t\t\t\t\tconst extension = fileNames[ 1 ].slice( - 4 ).toLowerCase();\n\n\t\t\t\t\t\tparams.envMap = this._loadTexture(\n\t\t\t\t\t\t\tfileNames[ 1 ],\n\t\t\t\t\t\t\ttextures\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tparams.combine = extension === '.sph'\n\t\t\t\t\t\t\t? MultiplyOperation\n\t\t\t\t\t\t\t: AddOperation;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\t// gradientMap\n\n\t\t\t\tconst toonFileName = ( material.toonIndex === - 1 )\n\t\t\t\t\t? 'toon00.bmp'\n\t\t\t\t\t: data.toonTextures[ material.toonIndex ].fileName;\n\n\t\t\t\tparams.gradientMap = this._loadTexture(\n\t\t\t\t\ttoonFileName,\n\t\t\t\t\ttextures,\n\t\t\t\t\t{\n\t\t\t\t\t\tisToonTexture: true,\n\t\t\t\t\t\tisDefaultToonTexture: this._isDefaultToonTexture( toonFileName )\n\t\t\t\t\t}\n\t\t\t\t);\n\n\t\t\t\t// parameters for OutlineEffect\n\n\t\t\t\tparams.userData.outlineParameters = {\n\t\t\t\t\tthickness: material.edgeFlag === 1 ? 0.003 : 0.0,\n\t\t\t\t\tcolor: [ 0, 0, 0 ],\n\t\t\t\t\talpha: 1.0,\n\t\t\t\t\tvisible: material.edgeFlag === 1\n\t\t\t\t};\n\n\t\t\t} else {\n\n\t\t\t\t// map\n\n\t\t\t\tif ( material.textureIndex !== - 1 ) {\n\n\t\t\t\t\tparams.map = this._loadTexture( data.textures[ material.textureIndex ], textures );\n\n\t\t\t\t}\n\n\t\t\t\t// envMap TODO: support m.envFlag === 3\n\n\t\t\t\tif ( material.envTextureIndex !== - 1 && ( material.envFlag === 1 || material.envFlag == 2 ) ) {\n\n\t\t\t\t\tparams.envMap = this._loadTexture(\n\t\t\t\t\t\tdata.textures[ material.envTextureIndex ],\n\t\t\t\t\t\ttextures\n\t\t\t\t\t);\n\n\t\t\t\t\tparams.combine = material.envFlag === 1\n\t\t\t\t\t\t? MultiplyOperation\n\t\t\t\t\t\t: AddOperation;\n\n\t\t\t\t}\n\n\t\t\t\t// gradientMap\n\n\t\t\t\tlet toonFileName, isDefaultToon;\n\n\t\t\t\tif ( material.toonIndex === - 1 || material.toonFlag !== 0 ) {\n\n\t\t\t\t\ttoonFileName = 'toon' + ( '0' + ( material.toonIndex + 1 ) ).slice( - 2 ) + '.bmp';\n\t\t\t\t\tisDefaultToon = true;\n\n\t\t\t\t} else {\n\n\t\t\t\t\ttoonFileName = data.textures[ material.toonIndex ];\n\t\t\t\t\tisDefaultToon = false;\n\n\t\t\t\t}\n\n\t\t\t\tparams.gradientMap = this._loadTexture(\n\t\t\t\t\ttoonFileName,\n\t\t\t\t\ttextures,\n\t\t\t\t\t{\n\t\t\t\t\t\tisToonTexture: true,\n\t\t\t\t\t\tisDefaultToonTexture: isDefaultToon\n\t\t\t\t\t}\n\t\t\t\t);\n\n\t\t\t\t// parameters for OutlineEffect\n\t\t\t\tparams.userData.outlineParameters = {\n\t\t\t\t\tthickness: material.edgeSize / 300, // TODO: better calculation?\n\t\t\t\t\tcolor: material.edgeColor.slice( 0, 3 ),\n\t\t\t\t\talpha: material.edgeColor[ 3 ],\n\t\t\t\t\tvisible: ( material.flag & 0x10 ) !== 0 && material.edgeSize > 0.0\n\t\t\t\t};\n\n\t\t\t}\n\n\t\t\tif ( params.map !== undefined ) {\n\n\t\t\t\tif ( ! params.transparent ) {\n\n\t\t\t\t\tthis._checkImageTransparency( params.map, geometry, i );\n\n\t\t\t\t}\n\n\t\t\t\tparams.emissive.multiplyScalar( 0.2 );\n\n\t\t\t}\n\n\t\t\tmaterials.push( new MeshToonMaterial( params ) );\n\n\t\t}\n\n\t\tif ( data.metadata.format === 'pmx' ) {\n\n\t\t\t// set transparent true if alpha morph is defined.\n\n\t\t\tfunction checkAlphaMorph( elements, materials ) {\n\n\t\t\t\tfor ( let i = 0, il = elements.length; i < il; i ++ ) {\n\n\t\t\t\t\tconst element = elements[ i ];\n\n\t\t\t\t\tif ( element.index === - 1 ) continue;\n\n\t\t\t\t\tconst material = materials[ element.index ];\n\n\t\t\t\t\tif ( material.opacity !== element.diffuse[ 3 ] ) {\n\n\t\t\t\t\t\tmaterial.transparent = true;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tfor ( let i = 0, il = data.morphs.length; i < il; i ++ ) {\n\n\t\t\t\tconst morph = data.morphs[ i ];\n\t\t\t\tconst elements = morph.elements;\n\n\t\t\t\tif ( morph.type === 0 ) {\n\n\t\t\t\t\tfor ( let j = 0, jl = elements.length; j < jl; j ++ ) {\n\n\t\t\t\t\t\tconst morph2 = data.morphs[ elements[ j ].index ];\n\n\t\t\t\t\t\tif ( morph2.type !== 8 ) continue;\n\n\t\t\t\t\t\tcheckAlphaMorph( morph2.elements, materials );\n\n\t\t\t\t\t}\n\n\t\t\t\t} else if ( morph.type === 8 ) {\n\n\t\t\t\t\tcheckAlphaMorph( elements, materials );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn materials;\n\n\t}\n\n\t// private methods\n\n\t_getTGALoader() {\n\n\t\tif ( this.tgaLoader === null ) {\n\n\t\t\tif ( TGALoader === undefined ) {\n\n\t\t\t\tthrow new Error( 'THREE.MMDLoader: Import TGALoader' );\n\n\t\t\t}\n\n\t\t\tthis.tgaLoader = new TGALoader( this.manager );\n\n\t\t}\n\n\t\treturn this.tgaLoader;\n\n\t}\n\n\t_isDefaultToonTexture( name ) {\n\n\t\tif ( name.length !== 10 ) return false;\n\n\t\treturn /toon(10|0[0-9])\\.bmp/.test( name );\n\n\t}\n\n\t_loadTexture( filePath, textures, params, onProgress, onError ) {\n\n\t\tparams = params || {};\n\n\t\tconst scope = this;\n\n\t\tlet fullPath;\n\n\t\tif ( params.isDefaultToonTexture === true ) {\n\n\t\t\tlet index;\n\n\t\t\ttry {\n\n\t\t\t\tindex = parseInt( filePath.match( /toon([0-9]{2})\\.bmp$/ )[ 1 ] );\n\n\t\t\t} catch ( e ) {\n\n\t\t\t\tconsole.warn( 'THREE.MMDLoader: ' + filePath + ' seems like a '\n\t\t\t\t\t\t+ 'not right default texture path. Using toon00.bmp instead.' );\n\n\t\t\t\tindex = 0;\n\n\t\t\t}\n\n\t\t\tfullPath = DEFAULT_TOON_TEXTURES[ index ];\n\n\t\t} else {\n\n\t\t\tfullPath = this.resourcePath + filePath;\n\n\t\t}\n\n\t\tif ( textures[ fullPath ] !== undefined ) return textures[ fullPath ];\n\n\t\tlet loader = this.manager.getHandler( fullPath );\n\n\t\tif ( loader === null ) {\n\n\t\t\tloader = ( filePath.slice( - 4 ).toLowerCase() === '.tga' )\n\t\t\t\t? this._getTGALoader()\n\t\t\t\t: this.textureLoader;\n\n\t\t}\n\n\t\tconst texture = loader.load( fullPath, function ( t ) {\n\n\t\t\t// MMD toon texture is Axis-Y oriented\n\t\t\t// but Three.js gradient map is Axis-X oriented.\n\t\t\t// So here replaces the toon texture image with the rotated one.\n\t\t\tif ( params.isToonTexture === true ) {\n\n\t\t\t\tt.image = scope._getRotatedImage( t.image );\n\n\t\t\t\tt.magFilter = NearestFilter;\n\t\t\t\tt.minFilter = NearestFilter;\n\n\t\t\t}\n\n\t\t\tt.flipY = false;\n\t\t\tt.wrapS = RepeatWrapping;\n\t\t\tt.wrapT = RepeatWrapping;\n\n\t\t\tfor ( let i = 0; i < texture.readyCallbacks.length; i ++ ) {\n\n\t\t\t\ttexture.readyCallbacks[ i ]( texture );\n\n\t\t\t}\n\n\t\t\tdelete texture.readyCallbacks;\n\n\t\t}, onProgress, onError );\n\n\t\ttexture.readyCallbacks = [];\n\n\t\ttextures[ fullPath ] = texture;\n\n\t\treturn texture;\n\n\t}\n\n\t_getRotatedImage( image ) {\n\n\t\tconst canvas = document.createElement( 'canvas' );\n\t\tconst context = canvas.getContext( '2d' );\n\n\t\tconst width = image.width;\n\t\tconst height = image.height;\n\n\t\tcanvas.width = width;\n\t\tcanvas.height = height;\n\n\t\tcontext.clearRect( 0, 0, width, height );\n\t\tcontext.translate( width / 2.0, height / 2.0 );\n\t\tcontext.rotate( 0.5 * Math.PI ); // 90.0 * Math.PI / 180.0\n\t\tcontext.translate( - width / 2.0, - height / 2.0 );\n\t\tcontext.drawImage( image, 0, 0 );\n\n\t\treturn context.getImageData( 0, 0, width, height );\n\n\t}\n\n\t// Check if the partial image area used by the texture is transparent.\n\t_checkImageTransparency( map, geometry, groupIndex ) {\n\n\t\tmap.readyCallbacks.push( function ( texture ) {\n\n\t\t\t// Is there any efficient ways?\n\t\t\tfunction createImageData( image ) {\n\n\t\t\t\tconst canvas = document.createElement( 'canvas' );\n\t\t\t\tcanvas.width = image.width;\n\t\t\t\tcanvas.height = image.height;\n\n\t\t\t\tconst context = canvas.getContext( '2d' );\n\t\t\t\tcontext.drawImage( image, 0, 0 );\n\n\t\t\t\treturn context.getImageData( 0, 0, canvas.width, canvas.height );\n\n\t\t\t}\n\n\t\t\tfunction detectImageTransparency( image, uvs, indices ) {\n\n\t\t\t\tconst width = image.width;\n\t\t\t\tconst height = image.height;\n\t\t\t\tconst data = image.data;\n\t\t\t\tconst threshold = 253;\n\n\t\t\t\tif ( data.length / ( width * height ) !== 4 ) return false;\n\n\t\t\t\tfor ( let i = 0; i < indices.length; i += 3 ) {\n\n\t\t\t\t\tconst centerUV = { x: 0.0, y: 0.0 };\n\n\t\t\t\t\tfor ( let j = 0; j < 3; j ++ ) {\n\n\t\t\t\t\t\tconst index = indices[ i * 3 + j ];\n\t\t\t\t\t\tconst uv = { x: uvs[ index * 2 + 0 ], y: uvs[ index * 2 + 1 ] };\n\n\t\t\t\t\t\tif ( getAlphaByUv( image, uv ) < threshold ) return true;\n\n\t\t\t\t\t\tcenterUV.x += uv.x;\n\t\t\t\t\t\tcenterUV.y += uv.y;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tcenterUV.x /= 3;\n\t\t\t\t\tcenterUV.y /= 3;\n\n\t\t\t\t\tif ( getAlphaByUv( image, centerUV ) < threshold ) return true;\n\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\n\t\t\t}\n\n\t\t\t/*\n\t\t\t\t * This method expects\n\t\t\t\t *   texture.flipY = false\n\t\t\t\t *   texture.wrapS = RepeatWrapping\n\t\t\t\t *   texture.wrapT = RepeatWrapping\n\t\t\t\t * TODO: more precise\n\t\t\t\t */\n\t\t\tfunction getAlphaByUv( image, uv ) {\n\n\t\t\t\tconst width = image.width;\n\t\t\t\tconst height = image.height;\n\n\t\t\t\tlet x = Math.round( uv.x * width ) % width;\n\t\t\t\tlet y = Math.round( uv.y * height ) % height;\n\n\t\t\t\tif ( x < 0 ) x += width;\n\t\t\t\tif ( y < 0 ) y += height;\n\n\t\t\t\tconst index = y * width + x;\n\n\t\t\t\treturn image.data[ index * 4 + 3 ];\n\n\t\t\t}\n\n\t\t\tconst imageData = texture.image.data !== undefined\n\t\t\t\t? texture.image\n\t\t\t\t: createImageData( texture.image );\n\n\t\t\tconst group = geometry.groups[ groupIndex ];\n\n\t\t\tif ( detectImageTransparency(\n\t\t\t\timageData,\n\t\t\t\tgeometry.attributes.uv.array,\n\t\t\t\tgeometry.index.array.slice( group.start, group.start + group.count ) ) ) {\n\n\t\t\t\tmap.transparent = true;\n\n\t\t\t}\n\n\t\t} );\n\n\t}\n\n}\n\n//\n\nclass AnimationBuilder {\n\n\t/**\n\t * @param {Object} vmd - parsed VMD data\n\t * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\n\t * @return {AnimationClip}\n\t */\n\tbuild( vmd, mesh ) {\n\n\t\t// combine skeletal and morph animations\n\n\t\tconst tracks = this.buildSkeletalAnimation( vmd, mesh ).tracks;\n\t\tconst tracks2 = this.buildMorphAnimation( vmd, mesh ).tracks;\n\n\t\tfor ( let i = 0, il = tracks2.length; i < il; i ++ ) {\n\n\t\t\ttracks.push( tracks2[ i ] );\n\n\t\t}\n\n\t\treturn new AnimationClip( '', - 1, tracks );\n\n\t}\n\n\t/**\n\t * @param {Object} vmd - parsed VMD data\n\t * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\n\t * @return {AnimationClip}\n\t */\n\tbuildSkeletalAnimation( vmd, mesh ) {\n\n\t\tfunction pushInterpolation( array, interpolation, index ) {\n\n\t\t\tarray.push( interpolation[ index + 0 ] / 127 ); // x1\n\t\t\tarray.push( interpolation[ index + 8 ] / 127 ); // x2\n\t\t\tarray.push( interpolation[ index + 4 ] / 127 ); // y1\n\t\t\tarray.push( interpolation[ index + 12 ] / 127 ); // y2\n\n\t\t}\n\n\t\tconst tracks = [];\n\n\t\tconst motions = {};\n\t\tconst bones = mesh.skeleton.bones;\n\t\tconst boneNameDictionary = {};\n\n\t\tfor ( let i = 0, il = bones.length; i < il; i ++ ) {\n\n\t\t\tboneNameDictionary[ bones[ i ].name ] = true;\n\n\t\t}\n\n\t\tfor ( let i = 0; i < vmd.metadata.motionCount; i ++ ) {\n\n\t\t\tconst motion = vmd.motions[ i ];\n\t\t\tconst boneName = motion.boneName;\n\n\t\t\tif ( boneNameDictionary[ boneName ] === undefined ) continue;\n\n\t\t\tmotions[ boneName ] = motions[ boneName ] || [];\n\t\t\tmotions[ boneName ].push( motion );\n\n\t\t}\n\n\t\tfor ( const key in motions ) {\n\n\t\t\tconst array = motions[ key ];\n\n\t\t\tarray.sort( function ( a, b ) {\n\n\t\t\t\treturn a.frameNum - b.frameNum;\n\n\t\t\t} );\n\n\t\t\tconst times = [];\n\t\t\tconst positions = [];\n\t\t\tconst rotations = [];\n\t\t\tconst pInterpolations = [];\n\t\t\tconst rInterpolations = [];\n\n\t\t\tconst basePosition = mesh.skeleton.getBoneByName( key ).position.toArray();\n\n\t\t\tfor ( let i = 0, il = array.length; i < il; i ++ ) {\n\n\t\t\t\tconst time = array[ i ].frameNum / 30;\n\t\t\t\tconst position = array[ i ].position;\n\t\t\t\tconst rotation = array[ i ].rotation;\n\t\t\t\tconst interpolation = array[ i ].interpolation;\n\n\t\t\t\ttimes.push( time );\n\n\t\t\t\tfor ( let j = 0; j < 3; j ++ ) positions.push( basePosition[ j ] + position[ j ] );\n\t\t\t\tfor ( let j = 0; j < 4; j ++ ) rotations.push( rotation[ j ] );\n\t\t\t\tfor ( let j = 0; j < 3; j ++ ) pushInterpolation( pInterpolations, interpolation, j );\n\n\t\t\t\tpushInterpolation( rInterpolations, interpolation, 3 );\n\n\t\t\t}\n\n\t\t\tconst targetName = '.bones[' + key + ']';\n\n\t\t\ttracks.push( this._createTrack( targetName + '.position', VectorKeyframeTrack, times, positions, pInterpolations ) );\n\t\t\ttracks.push( this._createTrack( targetName + '.quaternion', QuaternionKeyframeTrack, times, rotations, rInterpolations ) );\n\n\t\t}\n\n\t\treturn new AnimationClip( '', - 1, tracks );\n\n\t}\n\n\t/**\n\t * @param {Object} vmd - parsed VMD data\n\t * @param {SkinnedMesh} mesh - tracks will be fitting to mesh\n\t * @return {AnimationClip}\n\t */\n\tbuildMorphAnimation( vmd, mesh ) {\n\n\t\tconst tracks = [];\n\n\t\tconst morphs = {};\n\t\tconst morphTargetDictionary = mesh.morphTargetDictionary;\n\n\t\tfor ( let i = 0; i < vmd.metadata.morphCount; i ++ ) {\n\n\t\t\tconst morph = vmd.morphs[ i ];\n\t\t\tconst morphName = morph.morphName;\n\n\t\t\tif ( morphTargetDictionary[ morphName ] === undefined ) continue;\n\n\t\t\tmorphs[ morphName ] = morphs[ morphName ] || [];\n\t\t\tmorphs[ morphName ].push( morph );\n\n\t\t}\n\n\t\tfor ( const key in morphs ) {\n\n\t\t\tconst array = morphs[ key ];\n\n\t\t\tarray.sort( function ( a, b ) {\n\n\t\t\t\treturn a.frameNum - b.frameNum;\n\n\t\t\t} );\n\n\t\t\tconst times = [];\n\t\t\tconst values = [];\n\n\t\t\tfor ( let i = 0, il = array.length; i < il; i ++ ) {\n\n\t\t\t\ttimes.push( array[ i ].frameNum / 30 );\n\t\t\t\tvalues.push( array[ i ].weight );\n\n\t\t\t}\n\n\t\t\ttracks.push( new NumberKeyframeTrack( '.morphTargetInfluences[' + morphTargetDictionary[ key ] + ']', times, values ) );\n\n\t\t}\n\n\t\treturn new AnimationClip( '', - 1, tracks );\n\n\t}\n\n\t/**\n\t * @param {Object} vmd - parsed VMD data\n\t * @return {AnimationClip}\n\t */\n\tbuildCameraAnimation( vmd ) {\n\n\t\tfunction pushVector3( array, vec ) {\n\n\t\t\tarray.push( vec.x );\n\t\t\tarray.push( vec.y );\n\t\t\tarray.push( vec.z );\n\n\t\t}\n\n\t\tfunction pushQuaternion( array, q ) {\n\n\t\t\tarray.push( q.x );\n\t\t\tarray.push( q.y );\n\t\t\tarray.push( q.z );\n\t\t\tarray.push( q.w );\n\n\t\t}\n\n\t\tfunction pushInterpolation( array, interpolation, index ) {\n\n\t\t\tarray.push( interpolation[ index * 4 + 0 ] / 127 ); // x1\n\t\t\tarray.push( interpolation[ index * 4 + 1 ] / 127 ); // x2\n\t\t\tarray.push( interpolation[ index * 4 + 2 ] / 127 ); // y1\n\t\t\tarray.push( interpolation[ index * 4 + 3 ] / 127 ); // y2\n\n\t\t}\n\n\t\tconst cameras = vmd.cameras === undefined ? [] : vmd.cameras.slice();\n\n\t\tcameras.sort( function ( a, b ) {\n\n\t\t\treturn a.frameNum - b.frameNum;\n\n\t\t} );\n\n\t\tconst times = [];\n\t\tconst centers = [];\n\t\tconst quaternions = [];\n\t\tconst positions = [];\n\t\tconst fovs = [];\n\n\t\tconst cInterpolations = [];\n\t\tconst qInterpolations = [];\n\t\tconst pInterpolations = [];\n\t\tconst fInterpolations = [];\n\n\t\tconst quaternion = new Quaternion();\n\t\tconst euler = new Euler();\n\t\tconst position = new Vector3();\n\t\tconst center = new Vector3();\n\n\t\tfor ( let i = 0, il = cameras.length; i < il; i ++ ) {\n\n\t\t\tconst motion = cameras[ i ];\n\n\t\t\tconst time = motion.frameNum / 30;\n\t\t\tconst pos = motion.position;\n\t\t\tconst rot = motion.rotation;\n\t\t\tconst distance = motion.distance;\n\t\t\tconst fov = motion.fov;\n\t\t\tconst interpolation = motion.interpolation;\n\n\t\t\ttimes.push( time );\n\n\t\t\tposition.set( 0, 0, - distance );\n\t\t\tcenter.set( pos[ 0 ], pos[ 1 ], pos[ 2 ] );\n\n\t\t\teuler.set( - rot[ 0 ], - rot[ 1 ], - rot[ 2 ] );\n\t\t\tquaternion.setFromEuler( euler );\n\n\t\t\tposition.add( center );\n\t\t\tposition.applyQuaternion( quaternion );\n\n\t\t\tpushVector3( centers, center );\n\t\t\tpushQuaternion( quaternions, quaternion );\n\t\t\tpushVector3( positions, position );\n\n\t\t\tfovs.push( fov );\n\n\t\t\tfor ( let j = 0; j < 3; j ++ ) {\n\n\t\t\t\tpushInterpolation( cInterpolations, interpolation, j );\n\n\t\t\t}\n\n\t\t\tpushInterpolation( qInterpolations, interpolation, 3 );\n\n\t\t\t// use the same parameter for x, y, z axis.\n\t\t\tfor ( let j = 0; j < 3; j ++ ) {\n\n\t\t\t\tpushInterpolation( pInterpolations, interpolation, 4 );\n\n\t\t\t}\n\n\t\t\tpushInterpolation( fInterpolations, interpolation, 5 );\n\n\t\t}\n\n\t\tconst tracks = [];\n\n\t\t// I expect an object whose name 'target' exists under THREE.Camera\n\t\ttracks.push( this._createTrack( 'target.position', VectorKeyframeTrack, times, centers, cInterpolations ) );\n\n\t\ttracks.push( this._createTrack( '.quaternion', QuaternionKeyframeTrack, times, quaternions, qInterpolations ) );\n\t\ttracks.push( this._createTrack( '.position', VectorKeyframeTrack, times, positions, pInterpolations ) );\n\t\ttracks.push( this._createTrack( '.fov', NumberKeyframeTrack, times, fovs, fInterpolations ) );\n\n\t\treturn new AnimationClip( '', - 1, tracks );\n\n\t}\n\n\t// private method\n\n\t_createTrack( node, typedKeyframeTrack, times, values, interpolations ) {\n\n\t\t/*\n\t\t\t * optimizes here not to let KeyframeTrackPrototype optimize\n\t\t\t * because KeyframeTrackPrototype optimizes times and values but\n\t\t\t * doesn't optimize interpolations.\n\t\t\t */\n\t\tif ( times.length > 2 ) {\n\n\t\t\ttimes = times.slice();\n\t\t\tvalues = values.slice();\n\t\t\tinterpolations = interpolations.slice();\n\n\t\t\tconst stride = values.length / times.length;\n\t\t\tconst interpolateStride = interpolations.length / times.length;\n\n\t\t\tlet index = 1;\n\n\t\t\tfor ( let aheadIndex = 2, endIndex = times.length; aheadIndex < endIndex; aheadIndex ++ ) {\n\n\t\t\t\tfor ( let i = 0; i < stride; i ++ ) {\n\n\t\t\t\t\tif ( values[ index * stride + i ] !== values[ ( index - 1 ) * stride + i ] ||\n\t\t\t\t\t\t\tvalues[ index * stride + i ] !== values[ aheadIndex * stride + i ] ) {\n\n\t\t\t\t\t\tindex ++;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tif ( aheadIndex > index ) {\n\n\t\t\t\t\ttimes[ index ] = times[ aheadIndex ];\n\n\t\t\t\t\tfor ( let i = 0; i < stride; i ++ ) {\n\n\t\t\t\t\t\tvalues[ index * stride + i ] = values[ aheadIndex * stride + i ];\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfor ( let i = 0; i < interpolateStride; i ++ ) {\n\n\t\t\t\t\t\tinterpolations[ index * interpolateStride + i ] = interpolations[ aheadIndex * interpolateStride + i ];\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\ttimes.length = index + 1;\n\t\t\tvalues.length = ( index + 1 ) * stride;\n\t\t\tinterpolations.length = ( index + 1 ) * interpolateStride;\n\n\t\t}\n\n\t\tconst track = new typedKeyframeTrack( node, times, values );\n\n\t\ttrack.createInterpolant = function InterpolantFactoryMethodCubicBezier( result ) {\n\n\t\t\treturn new CubicBezierInterpolation( this.times, this.values, this.getValueSize(), result, new Float32Array( interpolations ) );\n\n\t\t};\n\n\t\treturn track;\n\n\t}\n\n}\n\n// interpolation\n\nclass CubicBezierInterpolation extends Interpolant {\n\n\tconstructor( parameterPositions, sampleValues, sampleSize, resultBuffer, params ) {\n\n\t\tsuper( parameterPositions, sampleValues, sampleSize, resultBuffer );\n\n\t\tthis.interpolationParams = params;\n\n\t}\n\n\tinterpolate_( i1, t0, t, t1 ) {\n\n\t\tconst result = this.resultBuffer;\n\t\tconst values = this.sampleValues;\n\t\tconst stride = this.valueSize;\n\t\tconst params = this.interpolationParams;\n\n\t\tconst offset1 = i1 * stride;\n\t\tconst offset0 = offset1 - stride;\n\n\t\t// No interpolation if next key frame is in one frame in 30fps.\n\t\t// This is from MMD animation spec.\n\t\t// '1.5' is for precision loss. times are Float32 in Three.js Animation system.\n\t\tconst weight1 = ( ( t1 - t0 ) < 1 / 30 * 1.5 ) ? 0.0 : ( t - t0 ) / ( t1 - t0 );\n\n\t\tif ( stride === 4 ) { // Quaternion\n\n\t\t\tconst x1 = params[ i1 * 4 + 0 ];\n\t\t\tconst x2 = params[ i1 * 4 + 1 ];\n\t\t\tconst y1 = params[ i1 * 4 + 2 ];\n\t\t\tconst y2 = params[ i1 * 4 + 3 ];\n\n\t\t\tconst ratio = this._calculate( x1, x2, y1, y2, weight1 );\n\n\t\t\tQuaternion.slerpFlat( result, 0, values, offset0, values, offset1, ratio );\n\n\t\t} else if ( stride === 3 ) { // Vector3\n\n\t\t\tfor ( let i = 0; i !== stride; ++ i ) {\n\n\t\t\t\tconst x1 = params[ i1 * 12 + i * 4 + 0 ];\n\t\t\t\tconst x2 = params[ i1 * 12 + i * 4 + 1 ];\n\t\t\t\tconst y1 = params[ i1 * 12 + i * 4 + 2 ];\n\t\t\t\tconst y2 = params[ i1 * 12 + i * 4 + 3 ];\n\n\t\t\t\tconst ratio = this._calculate( x1, x2, y1, y2, weight1 );\n\n\t\t\t\tresult[ i ] = values[ offset0 + i ] * ( 1 - ratio ) + values[ offset1 + i ] * ratio;\n\n\t\t\t}\n\n\t\t} else { // Number\n\n\t\t\tconst x1 = params[ i1 * 4 + 0 ];\n\t\t\tconst x2 = params[ i1 * 4 + 1 ];\n\t\t\tconst y1 = params[ i1 * 4 + 2 ];\n\t\t\tconst y2 = params[ i1 * 4 + 3 ];\n\n\t\t\tconst ratio = this._calculate( x1, x2, y1, y2, weight1 );\n\n\t\t\tresult[ 0 ] = values[ offset0 ] * ( 1 - ratio ) + values[ offset1 ] * ratio;\n\n\t\t}\n\n\t\treturn result;\n\n\t}\n\n\t_calculate( x1, x2, y1, y2, x ) {\n\n\t\t/*\n\t\t\t * Cubic Bezier curves\n\t\t\t *   https://en.wikipedia.org/wiki/B%C3%A9zier_curve#Cubic_B.C3.A9zier_curves\n\t\t\t *\n\t\t\t * B(t) = ( 1 - t ) ^ 3 * P0\n\t\t\t *      + 3 * ( 1 - t ) ^ 2 * t * P1\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * P2\n\t\t\t *      + t ^ 3 * P3\n\t\t\t *      ( 0 <= t <= 1 )\n\t\t\t *\n\t\t\t * MMD uses Cubic Bezier curves for bone and camera animation interpolation.\n\t\t\t *   http://d.hatena.ne.jp/edvakf/20111016/1318716097\n\t\t\t *\n\t\t\t *    x = ( 1 - t ) ^ 3 * x0\n\t\t\t *      + 3 * ( 1 - t ) ^ 2 * t * x1\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * x2\n\t\t\t *      + t ^ 3 * x3\n\t\t\t *    y = ( 1 - t ) ^ 3 * y0\n\t\t\t *      + 3 * ( 1 - t ) ^ 2 * t * y1\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * y2\n\t\t\t *      + t ^ 3 * y3\n\t\t\t *      ( x0 = 0, y0 = 0 )\n\t\t\t *      ( x3 = 1, y3 = 1 )\n\t\t\t *      ( 0 <= t, x1, x2, y1, y2 <= 1 )\n\t\t\t *\n\t\t\t * Here solves this equation with Bisection method,\n\t\t\t *   https://en.wikipedia.org/wiki/Bisection_method\n\t\t\t * gets t, and then calculate y.\n\t\t\t *\n\t\t\t * f(t) = 3 * ( 1 - t ) ^ 2 * t * x1\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * x2\n\t\t\t *      + t ^ 3 - x = 0\n\t\t\t *\n\t\t\t * (Another option: Newton's method\n\t\t\t *    https://en.wikipedia.org/wiki/Newton%27s_method)\n\t\t\t */\n\n\t\tlet c = 0.5;\n\t\tlet t = c;\n\t\tlet s = 1.0 - t;\n\t\tconst loop = 15;\n\t\tconst eps = 1e-5;\n\t\tconst math = Math;\n\n\t\tlet sst3, stt3, ttt;\n\n\t\tfor ( let i = 0; i < loop; i ++ ) {\n\n\t\t\tsst3 = 3.0 * s * s * t;\n\t\t\tstt3 = 3.0 * s * t * t;\n\t\t\tttt = t * t * t;\n\n\t\t\tconst ft = ( sst3 * x1 ) + ( stt3 * x2 ) + ( ttt ) - x;\n\n\t\t\tif ( math.abs( ft ) < eps ) break;\n\n\t\t\tc /= 2.0;\n\n\t\t\tt += ( ft < 0 ) ? c : - c;\n\t\t\ts = 1.0 - t;\n\n\t\t}\n\n\t\treturn ( sst3 * y1 ) + ( stt3 * y2 ) + ttt;\n\n\t}\n\n}\n\nexport { MMDLoader };\n","import {\n\tCompressedTextureLoader,\n\tRGBAFormat,\n\tRGBA_S3TC_DXT3_Format,\n\tRGBA_S3TC_DXT5_Format,\n\tRGB_ETC1_Format,\n\tRGB_S3TC_DXT1_Format\n} from 'three';\n\nclass DDSLoader extends CompressedTextureLoader {\n\n\tconstructor( manager ) {\n\n\t\tsuper( manager );\n\n\t}\n\n\tparse( buffer, loadMipmaps ) {\n\n\t\tconst dds = { mipmaps: [], width: 0, height: 0, format: null, mipmapCount: 1 };\n\n\t\t// Adapted from @toji's DDS utils\n\t\t// https://github.com/toji/webgl-texture-utils/blob/master/texture-util/dds.js\n\n\t\t// All values and structures referenced from:\n\t\t// http://msdn.microsoft.com/en-us/library/bb943991.aspx/\n\n\t\tconst DDS_MAGIC = 0x20534444;\n\n\t\t// let DDSD_CAPS = 0x1;\n\t\t// let DDSD_HEIGHT = 0x2;\n\t\t// let DDSD_WIDTH = 0x4;\n\t\t// let DDSD_PITCH = 0x8;\n\t\t// let DDSD_PIXELFORMAT = 0x1000;\n\t\tconst DDSD_MIPMAPCOUNT = 0x20000;\n\t\t// let DDSD_LINEARSIZE = 0x80000;\n\t\t// let DDSD_DEPTH = 0x800000;\n\n\t\t// let DDSCAPS_COMPLEX = 0x8;\n\t\t// let DDSCAPS_MIPMAP = 0x400000;\n\t\t// let DDSCAPS_TEXTURE = 0x1000;\n\n\t\tconst DDSCAPS2_CUBEMAP = 0x200;\n\t\tconst DDSCAPS2_CUBEMAP_POSITIVEX = 0x400;\n\t\tconst DDSCAPS2_CUBEMAP_NEGATIVEX = 0x800;\n\t\tconst DDSCAPS2_CUBEMAP_POSITIVEY = 0x1000;\n\t\tconst DDSCAPS2_CUBEMAP_NEGATIVEY = 0x2000;\n\t\tconst DDSCAPS2_CUBEMAP_POSITIVEZ = 0x4000;\n\t\tconst DDSCAPS2_CUBEMAP_NEGATIVEZ = 0x8000;\n\t\t// let DDSCAPS2_VOLUME = 0x200000;\n\n\t\t// let DDPF_ALPHAPIXELS = 0x1;\n\t\t// let DDPF_ALPHA = 0x2;\n\t\tconst DDPF_FOURCC = 0x4;\n\t\t// let DDPF_RGB = 0x40;\n\t\t// let DDPF_YUV = 0x200;\n\t\t// let DDPF_LUMINANCE = 0x20000;\n\n\t\tfunction fourCCToInt32( value ) {\n\n\t\t\treturn value.charCodeAt( 0 ) +\n\t\t\t\t( value.charCodeAt( 1 ) << 8 ) +\n\t\t\t\t( value.charCodeAt( 2 ) << 16 ) +\n\t\t\t\t( value.charCodeAt( 3 ) << 24 );\n\n\t\t}\n\n\t\tfunction int32ToFourCC( value ) {\n\n\t\t\treturn String.fromCharCode(\n\t\t\t\tvalue & 0xff,\n\t\t\t\t( value >> 8 ) & 0xff,\n\t\t\t\t( value >> 16 ) & 0xff,\n\t\t\t\t( value >> 24 ) & 0xff\n\t\t\t);\n\n\t\t}\n\n\t\tfunction loadARGBMip( buffer, dataOffset, width, height ) {\n\n\t\t\tconst dataLength = width * height * 4;\n\t\t\tconst srcBuffer = new Uint8Array( buffer, dataOffset, dataLength );\n\t\t\tconst byteArray = new Uint8Array( dataLength );\n\t\t\tlet dst = 0;\n\t\t\tlet src = 0;\n\t\t\tfor ( let y = 0; y < height; y ++ ) {\n\n\t\t\t\tfor ( let x = 0; x < width; x ++ ) {\n\n\t\t\t\t\tconst b = srcBuffer[ src ]; src ++;\n\t\t\t\t\tconst g = srcBuffer[ src ]; src ++;\n\t\t\t\t\tconst r = srcBuffer[ src ]; src ++;\n\t\t\t\t\tconst a = srcBuffer[ src ]; src ++;\n\t\t\t\t\tbyteArray[ dst ] = r; dst ++;\t//r\n\t\t\t\t\tbyteArray[ dst ] = g; dst ++;\t//g\n\t\t\t\t\tbyteArray[ dst ] = b; dst ++;\t//b\n\t\t\t\t\tbyteArray[ dst ] = a; dst ++;\t//a\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn byteArray;\n\n\t\t}\n\n\t\tconst FOURCC_DXT1 = fourCCToInt32( 'DXT1' );\n\t\tconst FOURCC_DXT3 = fourCCToInt32( 'DXT3' );\n\t\tconst FOURCC_DXT5 = fourCCToInt32( 'DXT5' );\n\t\tconst FOURCC_ETC1 = fourCCToInt32( 'ETC1' );\n\n\t\tconst headerLengthInt = 31; // The header length in 32 bit ints\n\n\t\t// Offsets into the header array\n\n\t\tconst off_magic = 0;\n\n\t\tconst off_size = 1;\n\t\tconst off_flags = 2;\n\t\tconst off_height = 3;\n\t\tconst off_width = 4;\n\n\t\tconst off_mipmapCount = 7;\n\n\t\tconst off_pfFlags = 20;\n\t\tconst off_pfFourCC = 21;\n\t\tconst off_RGBBitCount = 22;\n\t\tconst off_RBitMask = 23;\n\t\tconst off_GBitMask = 24;\n\t\tconst off_BBitMask = 25;\n\t\tconst off_ABitMask = 26;\n\n\t\t// let off_caps = 27;\n\t\tconst off_caps2 = 28;\n\t\t// let off_caps3 = 29;\n\t\t// let off_caps4 = 30;\n\n\t\t// Parse header\n\n\t\tconst header = new Int32Array( buffer, 0, headerLengthInt );\n\n\t\tif ( header[ off_magic ] !== DDS_MAGIC ) {\n\n\t\t\tconsole.error( 'THREE.DDSLoader.parse: Invalid magic number in DDS header.' );\n\t\t\treturn dds;\n\n\t\t}\n\n\t\tif ( ! header[ off_pfFlags ] & DDPF_FOURCC ) {\n\n\t\t\tconsole.error( 'THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code.' );\n\t\t\treturn dds;\n\n\t\t}\n\n\t\tlet blockBytes;\n\n\t\tconst fourCC = header[ off_pfFourCC ];\n\n\t\tlet isRGBAUncompressed = false;\n\n\t\tswitch ( fourCC ) {\n\n\t\t\tcase FOURCC_DXT1:\n\n\t\t\t\tblockBytes = 8;\n\t\t\t\tdds.format = RGB_S3TC_DXT1_Format;\n\t\t\t\tbreak;\n\n\t\t\tcase FOURCC_DXT3:\n\n\t\t\t\tblockBytes = 16;\n\t\t\t\tdds.format = RGBA_S3TC_DXT3_Format;\n\t\t\t\tbreak;\n\n\t\t\tcase FOURCC_DXT5:\n\n\t\t\t\tblockBytes = 16;\n\t\t\t\tdds.format = RGBA_S3TC_DXT5_Format;\n\t\t\t\tbreak;\n\n\t\t\tcase FOURCC_ETC1:\n\n\t\t\t\tblockBytes = 8;\n\t\t\t\tdds.format = RGB_ETC1_Format;\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\n\t\t\t\tif ( header[ off_RGBBitCount ] === 32\n\t\t\t\t\t&& header[ off_RBitMask ] & 0xff0000\n\t\t\t\t\t&& header[ off_GBitMask ] & 0xff00\n\t\t\t\t\t&& header[ off_BBitMask ] & 0xff\n\t\t\t\t\t&& header[ off_ABitMask ] & 0xff000000 ) {\n\n\t\t\t\t\tisRGBAUncompressed = true;\n\t\t\t\t\tblockBytes = 64;\n\t\t\t\t\tdds.format = RGBAFormat;\n\n\t\t\t\t} else {\n\n\t\t\t\t\tconsole.error( 'THREE.DDSLoader.parse: Unsupported FourCC code ', int32ToFourCC( fourCC ) );\n\t\t\t\t\treturn dds;\n\n\t\t\t\t}\n\n\t\t}\n\n\t\tdds.mipmapCount = 1;\n\n\t\tif ( header[ off_flags ] & DDSD_MIPMAPCOUNT && loadMipmaps !== false ) {\n\n\t\t\tdds.mipmapCount = Math.max( 1, header[ off_mipmapCount ] );\n\n\t\t}\n\n\t\tconst caps2 = header[ off_caps2 ];\n\t\tdds.isCubemap = caps2 & DDSCAPS2_CUBEMAP ? true : false;\n\t\tif ( dds.isCubemap && (\n\t\t\t! ( caps2 & DDSCAPS2_CUBEMAP_POSITIVEX ) ||\n\t\t\t! ( caps2 & DDSCAPS2_CUBEMAP_NEGATIVEX ) ||\n\t\t\t! ( caps2 & DDSCAPS2_CUBEMAP_POSITIVEY ) ||\n\t\t\t! ( caps2 & DDSCAPS2_CUBEMAP_NEGATIVEY ) ||\n\t\t\t! ( caps2 & DDSCAPS2_CUBEMAP_POSITIVEZ ) ||\n\t\t\t! ( caps2 & DDSCAPS2_CUBEMAP_NEGATIVEZ )\n\t\t) ) {\n\n\t\t\tconsole.error( 'THREE.DDSLoader.parse: Incomplete cubemap faces' );\n\t\t\treturn dds;\n\n\t\t}\n\n\t\tdds.width = header[ off_width ];\n\t\tdds.height = header[ off_height ];\n\n\t\tlet dataOffset = header[ off_size ] + 4;\n\n\t\t// Extract mipmaps buffers\n\n\t\tconst faces = dds.isCubemap ? 6 : 1;\n\n\t\tfor ( let face = 0; face < faces; face ++ ) {\n\n\t\t\tlet width = dds.width;\n\t\t\tlet height = dds.height;\n\n\t\t\tfor ( let i = 0; i < dds.mipmapCount; i ++ ) {\n\n\t\t\t\tlet byteArray, dataLength;\n\n\t\t\t\tif ( isRGBAUncompressed ) {\n\n\t\t\t\t\tbyteArray = loadARGBMip( buffer, dataOffset, width, height );\n\t\t\t\t\tdataLength = byteArray.length;\n\n\t\t\t\t} else {\n\n\t\t\t\t\tdataLength = Math.max( 4, width ) / 4 * Math.max( 4, height ) / 4 * blockBytes;\n\t\t\t\t\tbyteArray = new Uint8Array( buffer, dataOffset, dataLength );\n\n\t\t\t\t}\n\n\t\t\t\tconst mipmap = { 'data': byteArray, 'width': width, 'height': height };\n\t\t\t\tdds.mipmaps.push( mipmap );\n\n\t\t\t\tdataOffset += dataLength;\n\n\t\t\t\twidth = Math.max( width >> 1, 1 );\n\t\t\t\theight = Math.max( height >> 1, 1 );\n\n\t\t\t}\n\n\t\t}\n\n\t\treturn dds;\n\n\t}\n\n}\n\nexport { DDSLoader };\n","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/Horkeukamui-160.a7373f24.pmx\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/body_N.png\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/body.dds\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/body2_N.png\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/body2.dds\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/cloth_N.png\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/cloth.dds\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/cloth2.dds\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/cloth3.dds\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/cloth4.dds\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/cloth23_N.png\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/head.dds\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/nose.dds\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/Penis.dds\";","export default __webpack_public_path__ + \"src/client/model/Horkeukamui/tex/toon.dds\";","// Main.jsx\nimport React from 'react';\nimport styled from 'styled-components';\nimport throttle from 'lodash/throttle';\nimport * as dat from 'dat.gui';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';\nimport { MMDLoader } from 'three/examples/jsm/loaders/MMDLoader.js';\nimport { DDSLoader } from 'three/examples/jsm/loaders/DDSLoader.js';\nimport { MMDAnimationHelper } from 'three/examples/jsm/animation/MMDAnimationHelper.js';\nimport {\n  Scene,\n  WebGLRenderer,\n  PerspectiveCamera,\n  AxesHelper,\n  LoadingManager,\n} from 'three';\nimport Horkeukamui160 from '../../model/Horkeukamui/Horkeukamui-160.pmx';\n\nimport '../../model/Horkeukamui/tex/body_N.png';\nimport '../../model/Horkeukamui/tex/body.dds';\nimport '../../model/Horkeukamui/tex/body2_N.png';\nimport '../../model/Horkeukamui/tex/body2.dds';\nimport '../../model/Horkeukamui/tex/cloth_N.png';\nimport '../../model/Horkeukamui/tex/cloth.dds';\nimport '../../model/Horkeukamui/tex/cloth2.dds';\nimport '../../model/Horkeukamui/tex/cloth3.dds';\nimport '../../model/Horkeukamui/tex/cloth4.dds';\nimport '../../model/Horkeukamui/tex/cloth23_N.png';\nimport '../../model/Horkeukamui/tex/head.dds';\nimport '../../model/Horkeukamui/tex/nose.dds';\nimport '../../model/Horkeukamui/tex/Penis.dds';\nimport '../../model/Horkeukamui/tex/toon.dds';\n\nconst loadingManager = new LoadingManager();\nloadingManager.addHandler(/\\.dds$/i, new DDSLoader());\nconst mmdLoader = new MMDLoader(loadingManager);\n\nexport class Main extends React.PureComponent {\n  canvas = React.createRef();\n  gui = null;\n  camera = null;\n  cameraControls = null;\n  scene = null;\n  renderer = null;\n  rendererControlFolder = null;\n  clock = null;\n  animationFrame = null;\n  animationControls = {\n    shouldAnimate: false,\n    fps: 60, // todo\n  };\n  animationToogleUI = null;\n  stopAnimationTimeout = null;\n\n  initRenderer = () => {\n    const renderer = new WebGLRenderer({\n      canvas: this.canvas.current,\n      antialias: true,\n    });\n    this.renderer = renderer;\n    renderer.physicallyCorrectLights = true;\n    //renderer.toneMapping = THREE.ReinhardToneMapping;\n    renderer.toneMappingExposure = 1;\n    renderer.shadowMap.enabled = true;\n    //renderer.shadowMap.type = THREE.PCFSoftShadowMap;\n    renderer.setClearColor(0x222f3e);\n    this.rendererControlFolder = this.gui.addFolder('Renderer');\n    this.rendererControlFolder.add(this.renderer, 'physicallyCorrectLights');\n    this.rendererControlFolder\n      .add(this.renderer, 'toneMappingExposure')\n      .min(0)\n      .max(5)\n      .step(0.01);\n    this.rendererControlFolder\n      .add(this.renderer.shadowMap, 'enabled')\n      .name('shadowMapEnabled');\n    this.initCamera();\n    this.handleWindowResize();\n  };\n\n  renderNextFrame = () => {\n    this.renderer.render(this.scene, this.camera);\n  };\n\n  tick = () => {\n    this.cameraControls.update();\n    this.renderNextFrame();\n    if (this.animationControls.shouldAnimate) {\n      this.animationFrame = window.requestAnimationFrame(this.tick);\n    }\n  };\n\n  initCamera = () => {\n    const canvas = this.canvas.current;\n    const width = canvas.clientWidth;\n    const height = canvas.clientHeight;\n\n    this.camera = new PerspectiveCamera(75, width / height, 0.1, 100);\n    this.camera.position.set(0, 0, -4);\n\n    this.cameraControls = new OrbitControls(this.camera, canvas);\n    this.cameraControls.enableDamping = true;\n    this.cameraControls.addEventListener('change', () => {\n      if (!this.animationControls.shouldAnimate) {\n        this.renderNextFrame();\n      }\n    });\n    this.cameraControls.addEventListener('end', () => {\n      if (this.animationControls.shouldAnimate) {\n        return;\n      }\n      this.animationToogleUI.setValue(true);\n      window.clearTimeout(this.stopAnimationTimeout);\n      this.stopAnimationTimeout = setTimeout(() => {\n        this.animationToogleUI.setValue(false);\n      }, 5000);\n    });\n  };\n\n  handleWindowResize = throttle(() => {\n    if (!this.canvas.current) {\n      return;\n    }\n    const canvas = this.canvas.current;\n    const renderer = this.renderer;\n    const width = canvas.clientWidth;\n    const height = canvas.clientHeight;\n    renderer.setSize(width, height);\n    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));\n\n    this.camera.aspect = width / height;\n    this.camera.updateProjectionMatrix();\n    if (!this.animationControls.shouldAnimate) {\n      this.renderNextFrame();\n    }\n  }, 100);\n\n  loadModels = () => {\n    // eslint-disable-next-line no-console\n    console.log('MMDAnimationHelper:', MMDAnimationHelper);\n    mmdLoader.load(Horkeukamui160, mmd => {\n      mmd.scale.set(0.3, 0.3, 0.3);\n      mmd.position.set(0, -4, 0);\n      mmd.rotation.y = Math.PI * 0.6;\n      window.Horkeukamui = mmd;\n      this.scene.add(mmd);\n      mmd.material.forEach(material => {\n        if ('' === material.name) {\n          material.visible = false;\n          material.opacity = 1;\n        }\n        if ('' === material.name) {\n          material.visible = true;\n          material.opacity = 1;\n        }\n        if ('' === material.name) {\n          material.visible = true;\n          material.opacity = 1;\n        }\n        if ('' === material.name) {\n          //material.visible = true;\n          //material.opacity = 1;\n        }\n      });\n      this.renderNextFrame();\n    });\n  };\n\n  componentDidMount() {\n    this.gui = new dat.GUI({ hideable: true, closed: false, closeOnTop: true });\n    this.scene = new Scene();\n    this.scene.add(new AxesHelper(1));\n    this.initRenderer();\n    this.animationToogleUI = this.gui\n      .add(this.animationControls, 'shouldAnimate')\n      .onChange(() => {\n        if (this.animationControls.shouldAnimate) {\n          this.tick();\n        }\n      });\n    window.addEventListener('resize', this.handleWindowResize);\n    this.loadModels();\n  }\n\n  componentWillUnmount() {\n    if (this.gui) {\n      this.gui.destory();\n    }\n    window.cancelAnimationFrame(this.animationFrame);\n    window.removeEventListener('resize', this.handleWindowResize);\n    window.clearTimeout(this.stopAnimationTimeout);\n  }\n\n  render() {\n    return (\n      <StyledMain>\n        <Canvas ref={this.canvas} />\n      </StyledMain>\n    );\n  }\n}\n\nconst StyledMain = styled.div`\n  flex: auto;\n`;\n\nconst Canvas = styled.canvas`\n  width: 100%;\n  height: 100%;\n  background-color: #222f3e;\n`;\n\nexport default Main;\n","export default __webpack_public_path__ + \"img/github-icon.e1201fcc.svg\";","// Footer.jsx\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport styled from 'styled-components';\n\nimport EmailIcon from '../../img/email-icon.svg';\nimport GithubIcon from '../../img/github-icon.svg';\n\nconst githubBaseUrl = 'https://github.com/bill42362/portfolio';\n\nexport class Footer extends React.PureComponent {\n  render() {\n    const { email, branchName } = this.props;\n    const githubUrl = branchName\n      ? `${githubBaseUrl}/tree/${branchName}`\n      : githubBaseUrl;\n    return (\n      <StyledFooter>\n        <Link href={githubUrl} target=\"_blank\">\n          <img src={GithubIcon} alt=\"github\" />\n        </Link>\n        <Link href={`mailto:${email}`} target=\"_blank\">\n          <img src={EmailIcon} alt=\"email\" />\n        </Link>\n      </StyledFooter>\n    );\n  }\n}\n\nFooter.propTypes = {\n  email: PropTypes.string,\n  branchName: PropTypes.string,\n};\n\nFooter.defaultProps = {\n  email: 'bill42362@gmail.com',\n  branchName: '',\n};\n\nconst StyledFooter = styled.div`\n  flex: none;\n  display: flex;\n  justify-content: center;\n  align-items: flex-end;\n  padding: 20px;\n`;\n\nconst Link = styled.a`\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  border-radius: 50%;\n  width: 36px;\n  height: 36px;\n  background-color: #576574;\n\n  & + & {\n    margin-left: 8px;\n  }\n  img {\n    width: 60%;\n    height: auto;\n  }\n`;\n\nexport default Footer;\n","export default \"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBkPSJNNDY3LDYxSDQ1QzIwLjIxOCw2MSwwLDgxLjE5NiwwLDEwNnYzMDBjMCwyNC43MiwyMC4xMjgsNDUsNDUsNDVoNDIyYzI0LjcyLDAsNDUtMjAuMTI4LDQ1LTQ1VjEwNiBDNTEyLDgxLjI4LDQ5MS44NzIsNjEsNDY3LDYxeiBNNDYwLjc4Niw5MUwyNTYuOTU0LDI5NC44MzNMNTEuMzU5LDkxSDQ2MC43ODZ6IE0zMCwzOTkuNzg4VjExMi4wNjlsMTQ0LjQ3OSwxNDMuMjRMMzAsMzk5Ljc4OHogTTUxLjIxMyw0MjFsMTQ0LjU3LTE0NC41N2w1MC42NTcsNTAuMjIyYzUuODY0LDUuODE0LDE1LjMyNyw1Ljc5NSwyMS4xNjctMC4wNDZMMzE3LDI3Ny4yMTNMNDYwLjc4Nyw0MjFINTEuMjEzeiBNNDgyLDM5OS43ODcgTDMzOC4yMTMsMjU2TDQ4MiwxMTIuMjEyVjM5OS43ODd6Ii8+PC9zdmc+\"","// index.js\n'use strict';\nimport React from 'react';\nimport ReactDOM from 'react-dom';\n\nimport App from './component/App.jsx';\n\nReactDOM.render(<App />, document.getElementById('app-root'));\n","var g;\n\n// This works in non-strict mode\ng = (function() {\n\treturn this;\n})();\n\ntry {\n\t// This works if eval is allowed (see CSP)\n\tg = g || new Function(\"return this\")();\n} catch (e) {\n\t// This works if the window reference is available\n\tif (typeof window === \"object\") g = window;\n}\n\n// g can still be undefined, but nothing to do about it...\n// We return undefined, instead of nothing here, so it's\n// easier to handle this case. if(!global) { ...}\n\nmodule.exports = g;\n","// App.jsx\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport { hot } from 'react-hot-loader/root';\nimport styled, {\n  createGlobalStyle,\n  StyleSheetManager,\n} from 'styled-components';\nimport styledNormalize from 'styled-normalize';\nimport { Helmet } from 'react-helmet';\n\nimport Main from '../component/Main.jsx';\nimport Footer from '../component/Footer.jsx';\nimport XMenLogoSource from '../../img/x-men-school.svg';\n\nconst GlobalStyle = createGlobalStyle`\n  ${styledNormalize};\n  *, ::after, ::before { box-sizing: border-box; }\n  body {\n    background-color: #101010;\n    color: #efefef;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\",\n      Arial, sans-serif, \"Apple Color Emoji\", \"Segoe UI Emoji\", \"Segoe UI Symbol\";\n    font-weight: 400;\n    -webkit-tap-highlight-color: transparent;\n    overscroll-behavior-y: contain;\n  }\n  button {\n    background-color: rgba(0, 0, 0, 0);\n    cursor: pointer;\n    &:disabled {\n      cursor: not-allowed;\n    }\n  }\n  input::placeholder,\n  input::-webkit-input-placeholder,\n  input::-moz-placeholder {\n    line-height: normal !important;\n    vertical-align: middle;\n  }\n  a { color: inherit; text-decoration: none; }\n  a > * { opacity: inherit; }\n  a:hover { opacity: .7; }\n`;\n\nconst isServer = typeof window === 'undefined';\nconst title = 'Portfolio';\nconst description = \"Bill's portfolio\";\nconst branchName = isServer\n  ? process.env.BRANCH_NAME\n  : window.__SSR_ENVIRONMENT__.branchName;\n\nconst App = ({ request }) => {\n  // eslint-disable-next-line no-console\n  console.log('App() request:', request);\n  return (\n    <>\n      <Helmet defaultTitle=\"Portfolio\" titleTemplate=\"%s - Portfolio\">\n        <meta charSet=\"utf-8\" />\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n\n        <meta name=\"author\" content=\"Bill\" />\n        <meta name=\"description\" content={description} />\n\n        <meta\n          property=\"og:url\"\n          content=\"https://github.com/bill42362/portfolio\"\n        />\n        <meta property=\"og:type\" content=\"website\" />\n        <meta property=\"og:title\" content={title} />\n        <meta property=\"og:description\" content={description} />\n        <meta property=\"og:site_name\" content={title} />\n        <meta property=\"twitter:card\" content=\"summary\" />\n        <meta property=\"twitter:site\" content=\"@bill_portfolio\" />\n        {/* <meta property=\"twitter:image\" content={twitterImageSource} /> */}\n      </Helmet>\n      <GlobalStyle />\n      <StyledApp>\n        {!window && <img src={XMenLogoSource} title=\"Xavier school\" />}\n        <Main />\n        <Footer branchName={branchName} />\n      </StyledApp>\n    </>\n  );\n};\n\nApp.propTypes = {\n  request: PropTypes.object,\n};\n\nApp.defaultProps = {\n  request: null,\n};\n\nconst StyledApp = styled.div`\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  height: 100vh;\n  background-color: #222f3e;\n`;\n\nconst Body = ({ sheet, ...props }) => {\n  if (sheet.instance) {\n    return (\n      <StyleSheetManager sheet={sheet.instance}>\n        <App {...props} />\n      </StyleSheetManager>\n    );\n  } else {\n    return <App {...props} />;\n  }\n};\n\nBody.propTypes = {\n  ...App.propTypes,\n  sheet: PropTypes.object,\n};\n\nBody.defaultProps = {\n  ...App.defaultProps,\n  sheet: {},\n};\n\nexport default hot(Body);\n"],"sourceRoot":""}